<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webapp meetra</title>
    <link rel="stylesheet" href="style.css">
    <!-- Preloading standard fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Importing Playfair Display as fallback for Apoc and Inter for UI text -->
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <div id="app-layout">
        <!-- Sidebar -->
        <aside id="sidebar">
            <button id="sidebar-toggle" title="Menü ein/ausklappen">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="sidebar-header">
                <img src="meetra logo remove.png" alt="meetra Logo" class="logo">
            </div>

            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="#home" class="nav-link active" data-target="home">
                            <!-- Solid House Icon -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                            </svg>
                            <span>Startseite</span>
                        </a>
                    </li>
                    <li>
                        <a href="#tasks" class="nav-link" data-target="tasks">
                            <!-- List with Checks Icon -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M8 6h13" />
                                <path d="M8 12h13" />
                                <path d="M8 18h13" />
                                <path d="M3 6h.01" />
                                <path d="M3 12h.01" />
                                <path d="M3 18h.01" />
                            </svg>
                            <span>Aufgaben</span>
                        </a>
                    </li>
                    <li>
                        <a href="#machines" class="nav-link" data-target="machines">
                            <!-- Excavator (Bagger) Icon -->
                            <!-- Detailed Excavator (Bagger) Icon -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 15h12l1 1v2l-1 1H3l-1-1v-2l1-1z" />
                                <path d="M13 13V8l5-5 4 4-3 3" />
                                <path d="M13 13h4l2 3" />
                            </svg>
                            <span>Maschinen</span>
                        </a>
                    </li>
                    <li>
                        <a href="#service" class="nav-link" data-target="service">
                            <!-- Crossed Tools Icon -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                                <path
                                    d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z" />
                            </svg>
                            <span>Serviceberichte</span>
                        </a>
                    </li>
                    <li>
                        <a href="#calendar" class="nav-link" data-target="calendar">
                            <!-- Calendar Icon -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span>Kalender</span>
                        </a>
                    </li>
                    <li>
                        <a href="#projects" class="nav-link" data-target="projects">
                            <!-- Project/Network Icon -->
                            <!-- 3-Node Hierarchy Icon (Solid Squares) -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <path d="M10 6.5h4" stroke-width="2" stroke="currentColor" fill="none"></path>
                                <path d="M6.5 10v7.5h7.5" stroke-width="2" stroke="currentColor" fill="none"></path>
                            </svg>
                            <span>Werkstatt</span>
                        </a>
                    </li>
                    <li>
                        <a href="#protocols" class="nav-link" data-target="protocols">
                            <!-- Protocols/Clipboard Icon -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2">
                                </path>
                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                <path d="M9 12h6"></path>
                                <path d="M9 16h6"></path>
                                <path d="M9 8h6"></path>
                            </svg>
                            <span>Protokolle</span>
                        </a>
                    </li>
                    <li>
                        <a href="#procurements" class="nav-link" data-target="procurements">
                            <!-- Package Icon for Orders -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                                <path
                                    d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                                </path>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                            </svg>
                            <span>Bestellungen</span>
                        </a>
                    </li>

                    <li>
                        <a href="#settings" class="nav-link" data-target="settings">
                            <!-- Solid Gear Icon -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                                <path
                                    d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.23.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6S13.98 15.6 12 15.6z" />
                            </svg>
                            <span>Einstellungen</span>
                        </a>
                    </li>
                    <!-- Hidden Link for Routing to Subviews -->
                    <li style="display:none;">
                        <a href="#users" class="nav-link" data-target="users">Benutzer</a>
                    </li>
                </ul>

                <!-- Sidebar Footer / Copyright -->
                <div class="sidebar-footer">
                    <div class="copyright">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M14.83 14.83a4 4 0 1 1 0-5.66"></path>
                        </svg>
                        <span>Mirco Loseke</span>
                    </div>
                </div>
        </aside>

        <!-- Main Content Area -->
        <div id="main-wrapper">
            <header id="topbar">
                <!-- Header Social Links (Left) -->
                <!-- Header Social Links (Left) -->
                <div class="header-social-links">
                    <a href="#" class="social-icon-btn instagram" title="Instagram">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>

                    <a href="#" class="social-icon-btn facebook" title="Facebook">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
                        </svg>
                    </a>

                    <a href="#" class="social-icon-btn youtube" title="YouTube">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.42a2.78 2.78 0 0 0-1.94 2C1 8.11 1 12 1 12s0 3.89.46 5.58a2.78 2.78 0 0 0 1.94 2C5.12 20 12 20 12 20s6.88 0 8.6-.42a2.78 2.78 0 0 0 1.94-2C23 15.89 23 12 23 12s0-3.89-.46-5.58z">
                            </path>
                            <polygon points="9.75 15.02 15.5 12 9.75 8.98 9.75 15.02"></polygon>
                        </svg>
                    </a>

                    <a href="#" class="social-icon-btn linkedin" title="LinkedIn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z">
                            </path>
                            <rect x="2" y="9" width="4" height="12"></rect>
                            <circle cx="4" cy="4" r="2"></circle>
                        </svg>
                    </a>

                </div>

                <!-- User Profile Switcher (Top Right) -->
                <div class="sidebar-user-profile" id="userProfileTrigger">
                    <div class="user-info">
                        <span class="user-name">Benutzer laden...</span>
                    </div>
                    <div class="user-avatar"></div>

                    <!-- Dropdown Menu -->
                    <div class="user-dropdown-menu">
                        <ul id="user-dropdown-list">
                            <!-- Dynamic User List -->
                        </ul>
                    </div>
                </div>
            </header>

            <main id="main-content">
                <!-- Home View -->
                <section id="home" class="view active">
                    <h1>Startseite / Dashboard</h1>
                </section>

                <!-- PROCUREMENTS VIEW -->
                <section id="procurements" class="view hidden">
                    <div class="tasks-header-container">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 2rem;">
                            <h1>Bestellungen</h1>
                            <div class="tasks-header-actions">
                                <div class="custom-search-wrapper" style="width: 250px;">
                                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    </svg>
                                    <input type="text" id="procurement-search-input"
                                        placeholder="Bestellungen suchen..." autocomplete="off"
                                        onkeyup="filterProcurements()">
                                </div>
                                <button class="btn-add-bg" onclick="openProcurementModal()">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Bestellung aufgeben
                                </button>
                            </div>
                        </div>

                        <!-- Procurement Filters -->
                        <div class="task-view-controls"
                            style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center; overflow-x: auto; padding-bottom: 5px;">
                            <button class="filter-pill active" onclick="filterProcurements('all')">Alle</button>
                            <button class="filter-pill" onclick="filterProcurements('new')">Neu</button>
                            <button class="filter-pill" onclick="filterProcurements('in_progress')">In
                                Bearbeitung</button>
                            <button class="filter-pill" onclick="filterProcurements('ordered')">Bestellt</button>
                            <button class="filter-pill" onclick="filterProcurements('received')">Erhalten</button>
                        </div>

                        <!-- Procurement List -->
                        <div class="glass-card" style="padding: 0; overflow: hidden;">
                            <table class="task-table" id="procurement-table">
                                <thead>
                                    <tr>
                                        <th>Nr.</th>
                                        <th>Kategorie</th>
                                        <th>Titel</th>
                                        <th>Status</th>
                                        <th>Priorität</th>
                                        <th>Ersteller</th>
                                        <th>Datum</th>
                                        <th>Aktion</th>
                                    </tr>
                                </thead>
                                <tbody id="procurement-list">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                            <div id="procurement-empty-state" class="empty-state hidden"
                                style="padding: 3rem; text-align: center;">
                                <p style="opacity: 0.6;">Keine Bestellungen gefunden.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Placeholders for other views -->
                <section id="tasks" class="view hidden">
                    <div class="tasks-header-container">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 2rem;">
                            <h1>Aufgaben</h1>
                            <div class="tasks-header-actions">
                                <div class="custom-search-wrapper" style="width: 250px;">
                                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    </svg>
                                    <input type="text" id="task-search-input" placeholder="Aufgaben suchen..."
                                        autocomplete="off">
                                </div>
                                <button class="btn-add-bg" onclick="openAddTaskModal()">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Aufgabe erstellen
                                </button>
                            </div>
                        </div>

                        <div class="task-view-controls"
                            style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center;">
                            <div class="calendar-view-tabs">
                                <button class="calendar-tab-btn active" id="btn-view-board"
                                    onclick="switchTaskView('board')">Board</button>
                                <button class="calendar-tab-btn" id="btn-view-list"
                                    onclick="switchTaskView('list')">Liste</button>
                            </div>

                            <div class="custom-filter-dropdown" id="task-project-filter-trigger">
                                <span class="filter-label" id="task-current-project-name">Alle Projekte</span>
                                <svg class="filter-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                                <div class="custom-filter-menu" id="task-project-filter-menu">
                                    <ul id="task-project-filter-options">
                                        <!-- Dynamically populated -->
                                    </ul>
                                </div>
                            </div>

                            <div class="custom-filter-dropdown" id="task-priority-filter-trigger">
                                <span class="filter-label" id="task-current-priority-name">Alle Prioritäten</span>
                                <svg class="filter-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                                <div class="custom-filter-menu" id="task-priority-filter-menu">
                                    <ul id="task-priority-filter-options">
                                        <li onclick="filterTasksByPriority('all')" class="selected">Alle</li>
                                        <li onclick="filterTasksByPriority('low')">Niedrig</li>
                                        <li onclick="filterTasksByPriority('medium')">Mittel</li>
                                        <li onclick="filterTasksByPriority('high')">Hoch</li>
                                        <li onclick="filterTasksByPriority('critical')">Kritisch</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tasks-board" class="kanban-board">
                        <div class="kanban-column" data-status="open">
                            <h3 class="column-title">Offen <span class="task-count">0</span></h3>
                            <div class="task-list" id="list-open"></div>
                        </div>
                        <div class="kanban-column" data-status="in_progress">
                            <h3 class="column-title">In Bearbeitung <span class="task-count">0</span></h3>
                            <div class="task-list" id="list-in-progress"></div>
                        </div>
                        <div class="kanban-column" data-status="completed">
                            <h3 class="column-title">Erledigt <span class="task-count">0</span></h3>
                            <div class="task-list" id="list-completed"></div>
                        </div>
                    </div>

                    <div id="tasks-list" class="hidden">
                        <div class="glass-card" style="padding: 0; overflow: hidden;">
                            <table class="task-table">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Aufgabe</th>
                                        <th>Priorität</th>
                                        <th>Projekt</th>
                                        <th>Deadline</th>
                                        <th>Zugeordnet</th>
                                        <th>Fortschritt</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="task-table-body">
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                <section id="calendar" class="view hidden">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h1 style="margin: 0;">Kalender</h1>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <!-- Calendar Search Field -->
                            <div class="custom-search-wrapper" style="width: 250px;">
                                <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                <input type="text" id="calendar-search-input" placeholder="Termine suchen..."
                                    autocomplete="off">
                            </div>

                            <!-- Calendar Category Filter -->
                            <div class="custom-filter-dropdown" id="calendar-category-filter-trigger">
                                <span class="filter-label" id="calendar-current-category-name">Kategorien</span>
                                <svg class="filter-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                                <div class="custom-filter-menu" id="calendar-category-filter-menu">
                                    <ul id="calendar-category-filter-options">
                                        <!-- Dynamically populated -->
                                    </ul>
                                </div>
                            </div>

                            <!-- View Selector -->
                            <div class="calendar-view-tabs"
                                style="display: flex; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                                <button class="calendar-tab-btn active" onclick="switchCalendarView('day')">Tag</button>
                                <button class="calendar-tab-btn" onclick="switchCalendarView('week')">Woche</button>
                                <button class="calendar-tab-btn" onclick="switchCalendarView('month')">Monat</button>
                                <button class="calendar-tab-btn" onclick="switchCalendarView('year')">Jahr</button>
                            </div>
                            <!-- Navigation -->
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn-icon-soft" onclick="prevCalendar()"><svg width="20" height="20"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="15 18 9 12 15 6"></polyline>
                                    </svg></button>
                                <button class="btn-secondary compact" onclick="todayCalendar()">Heute</button>
                                <button class="btn-icon-soft" onclick="nextCalendar()"><svg width="20" height="20"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg></button>
                            </div>
                        </div>
                    </div>

                    <div id="calendar-container" class="glass-card"
                        style="padding: 0; overflow: hidden; min-height: 600px;">
                        <!-- JS renders calendar content here -->
                    </div>
                </section>
                <section id="machines" class="view hidden">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h1 style="margin: 0;">Maschinen</h1>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <!-- Machine Search Field -->
                            <div class="custom-search-wrapper">
                                <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                <input type="text" id="machine-search-input" placeholder="Suchen..." autocomplete="off">
                            </div>

                            <!-- Machine Category Filter -->
                            <div class="custom-filter-dropdown" id="machine-category-filter-trigger">
                                <span class="filter-label" id="current-category-name">Maschinenkategorien</span>
                                <svg class="filter-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>

                                <div class="custom-filter-menu" id="machine-category-filter-menu">
                                    <ul id="machine-category-filter-options">
                                        <!-- Dynamically populated -->
                                    </ul>
                                </div>
                            </div>

                            <!-- Contact Type Filter -->
                            <div class="custom-filter-dropdown" id="machine-contact-filter-trigger">
                                <span class="filter-label" id="current-contact-type-name">Art des Kontaktes</span>
                                <svg class="filter-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>

                                <div class="custom-filter-menu" id="machine-contact-filter-menu">
                                    <ul id="machine-contact-filter-options">
                                        <!-- Dynamically populated -->
                                    </ul>
                                </div>
                            </div>
                            <button id="add-machine-btn" class="btn-add-bg" onclick="openAddMachineModal()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    style="vertical-align: text-bottom; margin-right: 4px;">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Maschine hinzufügen
                            </button>
                        </div>
                    </div>

                    <div class="card-grid">
                        <!-- Example Machine Card -->
                        <div class="card">
                            <div class="card-image-placeholder"
                                style="background: linear-gradient(135deg, #E3F2FD, #BBDEFB); color: #1565C0;">
                                ⚙️
                            </div>
                            <div class="card-content">
                                <h2 class="card-title">Schredder X2000</h2>
                                <p class="card-description">
                                    <strong>Status:</strong> <span
                                        style="color: var(--color-primary-green); font-weight: 600;">Betriebsbereit</span><br>
                                    <small style="color: #666;">Nächste Wartung: 15.03.2024</small>
                                </p>
                                <div class="card-actions">
                                    <button class="btn-primary" onclick="window.openServiceActionsModal(event, 1)"
                                        style="flex: 1;">
                                        Details ansehen
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Add New Placeholder Card -->
                        <div class="card"
                            style="border: 2px dashed #ccc; background: transparent; justify-content: center; align-items: center; cursor: pointer;"
                            onclick="document.getElementById('add-machine-btn').click()">
                            <div style="color: #999; text-align: center; padding: 2rem;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                <p
                                    style="margin-top: 1rem; font-weight: 700; font-family: 'Inter', sans-serif; color: #1a2732;">
                                    Neue Maschine</p>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="service" class="view hidden">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h1 style="margin: 0;">Serviceberichte</h1>

                        <!-- NEW Search Bar -->
                        <div class="custom-search-wrapper" style="margin-left: auto; margin-right: 1rem; width: 300px;">
                            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="service-search-input" placeholder="Serviceberichte suchen..."
                                autocomplete="off">
                        </div>

                        <button id="add-service-entry-btn" class="btn-add-bg" onclick="openServiceberichtModal()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                                style="vertical-align: text-bottom; margin-right: 4px;">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Anlegen
                        </button>
                    </div>

                    <div id="service-entries-list" class="card-grid">
                        <!-- Service entry cards will be rendered here -->
                        <div class="empty-state"
                            style="grid-column: 1 / -1; text-align: center; padding: 4rem 2rem; background: rgba(255,255,255,0.02); border-radius: 24px; border: 1px dashed rgba(255,255,255,0.1);">
                            <p style="color: rgba(255,255,255,0.4); font-size: 1.1rem;">Noch keine Serviceeinsätze
                                angelegt.</p>
                        </div>
                    </div>
                </section>



                <section id="projects" class="view hidden">
                    <div class="placeholder-content">
                        <h1>Projektplanung</h1>
                    </div>
                </section>
                <section id="protocols" class="view hidden">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; flex-wrap: wrap; gap: 1.5rem;">
                        <h1>Protokolle</h1>

                        <!-- Search and Filter Controls -->
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <!-- Search Bar -->
                            <div class="search-wrapper" style="position: relative; min-width: 300px;">
                                <input type="text" id="protocol-search-input" class="glass-search-input"
                                    placeholder="Protokolle durchsuchen..."
                                    oninput="window.handleProtocolSearch(this.value)" style="padding-left: 3rem;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                    stroke="rgba(255,255,255,0.4)" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round"
                                    style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%);">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </div>

                            <!-- Filter Group -->
                            <div class="filter-group-glass"
                                style="display: flex; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 4px;">
                                <button onclick="window.setProtocolFilter('all')" class="filter-btn active"
                                    id="filter-all">Alle</button>
                                <button onclick="window.setProtocolFilter('intake')" class="filter-btn"
                                    id="filter-intake">Eingang</button>
                                <button onclick="window.setProtocolFilter('acceptance')" class="filter-btn"
                                    id="filter-acceptance">Abnahme</button>
                            </div>
                        </div>
                    </div>

                    <!-- Protocol List -->
                    <div id="protocol-list-container" class="card-grid">
                        <!-- Protocol cards will be rendered here -->
                        <div class="empty-state"
                            style="grid-column: 1 / -1; text-align: center; padding: 4rem 2rem; background: rgba(255,255,255,0.02); border-radius: 24px; border: 1px dashed rgba(255,255,255,0.1);">
                            <p style="color: rgba(255,255,255,0.4); font-size: 1.1rem;">Lade Protokolle...</p>
                        </div>
                    </div>
                </section>
                <section id="settings" class="view hidden">
                    <div style="margin-bottom: 2rem;">
                        <h1>Einstellungen</h1>
                    </div>

                    <div class="settings-grid">
                        <!-- User Management Card -->
                        <div class="settings-card" data-target="users">
                            <div class="settings-icon-container users-icon">
                                <!-- Users with Gear Icon -->
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                                    <path
                                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                                    <circle cx="19" cy="19" r="3" fill="var(--color-white)" />
                                    <path
                                        d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1a5.52 5.52 0 0 0-1.69-.98l-.38-2.65A.488.488 0 0 0 14 2h-4c-.28 0-.5.22-.55.5l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.05.29.27.5.55.5h4c.28 0 .5-.22.55-.5l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.61l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"
                                        transform="scale(0.5) translate(24, 24)" fill="#2e7d32" />
                                </svg>
                            </div>
                            <div class="settings-content">
                                <h3>Benutzerverwaltung</h3>
                                <p>Benutzer hinzufügen, bearbeiten oder entfernen</p>
                            </div>
                        </div>

                        <!-- Categories Card -->
                        <div class="settings-card" data-target="categories">
                            <div class="settings-icon-container categories-icon">
                                <!-- Tag Icon -->
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                                    <path
                                        d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z" />
                                </svg>
                            </div>
                            <div class="settings-content">
                                <h3>Kategorien</h3>
                                <p>Maschinenkategorien verwalten</p>
                            </div>
                        </div>

                    </div>
                </section>
                <!-- Users View -->
                <section id="users" class="view hidden">
                    <div class="users-header-container">
                        <h1>Benutzerverwaltung</h1>
                        <div class="users-header-actions">
                            <button class="btn-back-custom" data-target="settings">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M19 12H5"></path>
                                    <path d="M12 19l-7-7 7-7"></path>
                                </svg>
                                ZURÜCK
                            </button>
                            <button id="add-user-btn" class="btn-add-bg">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="8.5" cy="7" r="4"></circle>
                                    <line x1="20" y1="8" x2="20" y2="14"></line>
                                    <line x1="23" y1="11" x2="17" y2="11"></line>
                                </svg>
                                BENUTZER ANLEGEN
                            </button>
                        </div>
                    </div>

                    <div class="user-list-container">
                        <ul id="user-list" class="user-list">
                            <!-- User items will be rendered here -->
                        </ul>
                    </div>
                </section>

                <!-- Categories View -->
                <section id="categories" class="view hidden">
                    <div class="users-header-container">
                        <h1>Kategorien</h1>
                        <div class="users-header-actions">
                            <button class="btn-back-custom" data-target="settings">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M19 12H5"></path>
                                    <path d="M12 19l-7-7 7-7"></path>
                                </svg>
                                ZURÜCK
                            </button>
                            <button id="add-category-btn" class="btn-add-bg">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 5v14M5 12h14"></path>
                                </svg>
                                KATEGORIE ANLEGEN
                            </button>
                        </div>
                    </div>

                    <div class="user-list-container">
                        <div class="categories-grid">
                            <div class="category-group">
                                <h3 class="category-group-title">
                                    <div class="group-icon-wrapper" id="icon-group-machine"
                                        onclick="document.getElementById('color-machine').click()" title="Farbe ändern">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <path d="M2 18a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2H2v4Z" />
                                            <path d="M3 14V9a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v5" />
                                            <path d="M13 11l5-4 5 4-2 4" />
                                            <path d="M18 7v4" />
                                            <circle cx="21" cy="15" r="1" />
                                            <path d="M8 8V5a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v3" />
                                        </svg>
                                    </div>
                                    <input type="color" id="color-machine" class="hidden-color-input"
                                        onchange="updateGroupColor('machine', this.value)">
                                    <span>Maschinenkategorien</span>
                                </h3>
                                <ul id="category-list-machine" class="user-list">
                                    <!-- Machine Categories rendered here -->
                                </ul>
                            </div>

                            <div class="category-group">
                                <h3 class="category-group-title">
                                    <div class="group-icon-wrapper" id="icon-group-service"
                                        onclick="document.getElementById('color-service').click()" title="Farbe ändern">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <path
                                                d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
                                        </svg>
                                    </div>
                                    <input type="color" id="color-service" class="hidden-color-input"
                                        onchange="updateGroupColor('service', this.value)">
                                    <span>Servicekategorien</span>
                                </h3>
                                <ul id="category-list-service" class="user-list">
                                    <!-- Service Categories rendered here -->
                                </ul>
                            </div>

                            <div class="category-group">
                                <h3 class="category-group-title">
                                    <div class="group-icon-wrapper" id="icon-group-contact"
                                        onclick="document.getElementById('color-contact').click()" title="Farbe ändern">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="9" cy="7" r="4"></circle>
                                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                        </svg>
                                    </div>
                                    <input type="color" id="color-contact" class="hidden-color-input"
                                        onchange="updateGroupColor('contact', this.value)">
                                    <span>Art des Kontaktes</span>
                                </h3>
                                <ul id="category-list-contact" class="user-list">
                                    <!-- Contact Categories rendered here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>


            </main>

            <!-- Calendar Navigation Popover -->
            <div id="calendar-nav-popover" class="calendar-nav-popover">
                <h4>Maschinen-Details</h4>
                <p>Möchten Sie zur Maschinen-Ansicht weitergeleitet werden, um die Details zu bearbeiten?</p>
                <div class="calendar-nav-actions">
                    <button class="calendar-nav-btn cancel" onclick="closeCalendarNavPopover()">Abbrechen</button>
                    <button class="calendar-nav-btn primary" onclick="confirmCalendarNavigation()">Weiterleiten</button>
                </div>
            </div>
        </div>
        <!-- Supabase JS -->
        <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

        <script>
            // Supabase Configuration
            const SUPABASE_URL = 'https://rtnpyziwyaqrlfazxkyr.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0bnB5eml3eWFxcmxmYXp4a3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MTAyMzUsImV4cCI6MjA4NjQ4NjIzNX0.6EHfeV_bqiftFMdo9ZQ24QLO3tA8_J-Ge-VPBiWgqH0';

            let supabaseClient;

            try {
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase object not found - library failed to load');
                }
                const { createClient } = supabase;
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase initialized successfully');
                window.supabaseClient = supabaseClient; // Make global for debugging
            } catch (err) {
                console.error('Supabase initialization critical error:', err);
                alert('Datenbank-Fehler: ' + err.message + '\nBitte prüfen Sie Ihre Internetverbindung und laden Sie die Seite neu.');
            }

            // Global Error Handler for user feedback
            window.onerror = function (msg, url, lineNo, columnNo, error) {
                const message = [
                    'Fehler: ' + msg,
                    'URL: ' + url,
                    'Zeile: ' + lineNo,
                    'Spalte: ' + columnNo,
                    'Error: ' + JSON.stringify(error)
                ].join('\n');
                console.error('GLOBAL ERROR:', message);
                // alert('Ein unerwarteter Fehler ist aufgetreten:\n' + msg);
                return false;
            };

            console.log('Inline Script Loaded');

            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM Ready');
                const sidebar = document.getElementById('sidebar');
                const mainWrapper = document.getElementById('main-wrapper');


                // Load Users if on user view or just generally on startup
                if (supabaseClient) {
                    fetchUsers(); // Users + Switcher
                    fetchCategories(); // Categories
                    fetchMachines(); // Machines
                    if (typeof fetchServiceEntries === 'function') fetchServiceEntries(); // Service Entries

                    // Initialize Machine Category Filter Trigger
                    const categoryFilterTrigger = document.getElementById('machine-category-filter-trigger');
                    if (categoryFilterTrigger) {
                        categoryFilterTrigger.addEventListener('click', toggleCategoryFilter);
                    }

                    // Initialize Machine Contact Filter Trigger
                    const contactFilterTrigger = document.getElementById('machine-contact-filter-trigger');
                    if (contactFilterTrigger) {
                        contactFilterTrigger.addEventListener('click', toggleContactFilter);
                    }
                }

                // Shared Navigation Function
                window.switchView = function (targetId) {
                    console.log('Switching to view:', targetId);
                    const views = document.querySelectorAll('.view');
                    const navLinks = document.querySelectorAll('.nav-link');
                    let found = false;

                    views.forEach(view => {
                        if (view.id === targetId) {
                            view.classList.remove('hidden');
                            view.classList.add('active');
                            view.style.display = 'block';
                            found = true;
                        } else {
                            view.classList.remove('active');
                            view.classList.add('hidden');
                            view.style.display = 'none';
                        }
                    });

                    // Update sidebar active states if the target matches a sidebar link
                    navLinks.forEach(link => {
                        if (link.getAttribute('data-target') === targetId) {
                            link.classList.add('active');
                        } else {
                            link.classList.remove('active');
                        }
                    });

                    // Special logic for specific views
                    if (targetId === 'home') {
                        renderDashboard();
                    }
                    if (targetId === 'service' && typeof fetchServiceEntries === 'function') {
                        fetchServiceEntries();
                    }
                    if (targetId === 'protocols' && typeof window.fetchProtocols === 'function') {
                        window.fetchProtocols();
                    }
                    if (targetId === 'calendar' && typeof renderCalendar === 'function') {
                        renderCalendar();
                    }
                    if (targetId === 'procurements' && typeof fetchProcurements === 'function') {
                        fetchProcurements();
                    }

                    if (!found) {
                        console.warn('View ID not found:', targetId);
                    }
                };

                // Initialize Settings Card Listeners
                const initSettingsNavigation = () => {
                    const settingsCards = document.querySelectorAll('.settings-card');
                    settingsCards.forEach(card => {
                        card.addEventListener('click', () => {
                            const target = card.getAttribute('data-target');
                            if (target) window.switchView(target);
                        });
                    });

                    const backBtns = document.querySelectorAll('.btn-back-custom');
                    backBtns.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const target = btn.getAttribute('data-target');
                            if (target) window.switchView(target);
                        });
                    });
                };

                // Initialize Settings Card Listeners directly since we are already inside a DOMContentLoaded
                initSettingsNavigation();

                // Navigation Listeners (Sidebar)
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = link.getAttribute('data-target');
                        if (targetId) switchView(targetId);
                    });
                });

                // Initialize User Dropdown
                const userTrigger = document.getElementById('userProfileTrigger');
                if (userTrigger) {
                    const dropdown = userTrigger.querySelector('.user-dropdown-menu');

                    userTrigger.addEventListener('click', (e) => {
                        e.stopPropagation();
                        dropdown.classList.toggle('show');
                    });

                    document.addEventListener('click', () => {
                        dropdown.classList.remove('show');
                    });
                }

                // ==========================================
                // USER SWITCHER LOGIC
                // ==========================================
                let activeUser = null;

                function renderUserDropdown() {
                    const dropdownList = document.getElementById('user-dropdown-list');
                    if (!dropdownList) return;

                    dropdownList.innerHTML = '';
                    console.log('Rendering user dropdown with', userList.length, 'users');

                    userList.forEach(user => {
                        const li = document.createElement('li');
                        li.style.display = 'flex';
                        li.style.alignItems = 'center';
                        li.style.gap = '12px';
                        li.style.padding = '12px 16px';

                        const initials = user.initials || user.name.substring(0, 2).toUpperCase();
                        li.innerHTML = `
                            <div class="user-avatar-small" style="width: 28px; height: 28px; border-radius: 50%; background-color: ${user.color || 'var(--primary-red)'}; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; color: white;">
                                ${initials}
                            </div>
                            <span style="flex: 1;">${user.name}</span>
                        `;

                        // Highlight active user
                        if (activeUser && activeUser.id === user.id) {
                            li.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
                            li.style.borderLeft = '3px solid ' + (user.color || 'var(--primary-red)');
                        }

                        li.onclick = (e) => {
                            e.stopPropagation();
                            console.log('User clicked:', user.name);
                            setActiveUser(user.id);
                        };
                        dropdownList.appendChild(li);
                    });
                }

                function setActiveUser(userId) {
                    const user = userList.find(u => u.id === userId);
                    if (!user) return;

                    activeUser = user;

                    // Update User Profile UI
                    const profileName = document.querySelector('.sidebar-user-profile .user-name');
                    const profileAvatar = document.querySelector('.sidebar-user-profile .user-avatar');

                    if (profileName) profileName.textContent = user.name;
                    if (profileAvatar) {
                        profileAvatar.textContent = user.initials || user.name.substring(0, 2).toUpperCase();
                        // Set background color from database - use shorthand to override any CSS gradients
                        if (user.color) {
                            profileAvatar.style.background = user.color;
                        }
                    }

                    // Save to LocalStorage
                    localStorage.setItem('activeUserId', userId);

                    // Re-render dropdown to update highlights
                    renderUserDropdown();

                    // Close dropdown
                    const dropdown = document.querySelector('.sidebar-user-profile .user-dropdown-menu');
                    if (dropdown) {
                        dropdown.classList.remove('show');
                    }

                    // Refresh dashboard if on home view
                    const homeView = document.getElementById('home');
                    if (homeView && !homeView.classList.contains('hidden')) {
                        renderDashboard();
                    }
                }

                async function updateLastViewed(machineId) {
                    if (!activeUser) return;

                    console.log('Updating last viewed for machine:', machineId);

                    // Get current list or default to empty array
                    let lastViewed = activeUser.last_viewed || [];
                    if (!Array.isArray(lastViewed)) lastViewed = [];

                    // Create new entry
                    const newEntry = {
                        machine_id: machineId,
                        viewed_at: new Date().toISOString()
                    };

                    // Remove if already exists (to move to front)
                    lastViewed = lastViewed.filter(entry => entry.machine_id !== machineId);

                    // Add to front
                    lastViewed.unshift(newEntry);

                    // Keep max 3
                    lastViewed = lastViewed.slice(0, 3);

                    // Update local object
                    activeUser.last_viewed = lastViewed;

                    // Update Supabase
                    const { error } = await supabaseClient
                        .from('users')
                        .update({ last_viewed: lastViewed })
                        .eq('id', activeUser.id);

                    if (error) {
                        console.error('Error updating last viewed:', error);
                    } else {
                        console.log('Successfully updated last viewed in Supabase');
                        // Refresh dashboard if we are on home view
                        const homeView = document.getElementById('home');
                        if (homeView && !homeView.classList.contains('hidden')) {
                            renderDashboard();
                        }
                    }
                }

                // ==========================================
                // FILE STORAGE LOGIC
                // ==========================================

                function updateFileNameDisplay() {
                    const input = document.getElementById('protocol-file-input');
                    const display = document.getElementById('file-name-display');
                    if (input.files && input.files.length > 0) {
                        display.textContent = input.files[0].name;
                        display.style.color = '#fff';
                    } else {
                        display.textContent = 'Keine Datei ausgewählt';
                        display.style.color = 'rgba(255,255,255,0.6)';
                    }
                }

                async function uploadFile() {
                    const input = document.getElementById('protocol-file-input');
                    if (!input.files || input.files.length === 0) {
                        alert('Bitte wählen Sie zuerst eine Datei aus.');
                        return;
                    }

                    const file = input.files[0];
                    // Sanitize filename and prepend timestamp
                    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.\-_]/g, '')}`;

                    // Show loading state
                    const btn = document.getElementById('upload-file-btn');
                    const originalText = btn.innerText;
                    btn.innerText = 'Wird hochgeladen...';
                    btn.disabled = true;

                    try {
                        console.log('Starting file upload to protocols bucket:', fileName);
                        const { data, error } = await supabaseClient
                            .storage
                            .from('files')
                            .upload(fileName, file);

                        if (error) {
                            console.error('Supabase Storage Error (Protocols):', error);
                            throw error;
                        }

                        console.log('File uploaded successfully:', data);
                        alert('Datei erfolgreich hochgeladen!');

                        // Reset input
                        input.value = '';
                        updateFileNameDisplay();

                        // Refresh list
                        fetchFiles();

                    } catch (err) {
                        console.error('Upload error:', err);
                        alert('Fehler beim Hochladen: ' + err.message);
                    } finally {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                }

                async function fetchFiles() {
                    const container = document.getElementById('file-list-container');
                    if (!container) return;

                    container.innerHTML = '<div style="color: rgba(255,255,255,0.5); grid-column: 1/-1; text-align: center;">Lade Dateien...</div>';

                    try {
                        const { data, error } = await supabaseClient
                            .storage
                            .from('files')
                            .list('', {
                                limit: 100,
                                offset: 0,
                                sortBy: { column: 'created_at', order: 'desc' },
                            });

                        if (error) {
                            throw error;
                        }

                        if (!data || data.length === 0) {
                            container.innerHTML = `
                                <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 4rem 2rem; background: rgba(255,255,255,0.02); border-radius: 24px; border: 1px dashed rgba(255,255,255,0.1);">
                                    <p style="color: rgba(255,255,255,0.4); font-size: 1.1rem;">Noch keine Dateien vorhanden.</p>
                                </div>
                            `;
                            return;
                        }

                        container.innerHTML = '';

                        data.forEach(file => {
                            if (file.name === '.emptyFolderPlaceholder') return; // Skip placeholder if exists

                            const publicUrl = supabaseClient.storage.from('files').getPublicUrl(file.name).data.publicUrl;
                            const isImage = file.metadata && file.metadata.mimetype && file.metadata.mimetype.startsWith('image/');

                            // Simple icon logic based on extension
                            let icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>';

                            if (isImage) {
                                icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>';
                            }

                            const card = document.createElement('div');
                            card.className = 'card';
                            card.innerHTML = `
                                <div class="card-image-placeholder" style="background: rgba(255,255,255,0.05); color: #fff; height: 120px; display: flex; align-items: center; justify-content: center;">
                                    ${isImage ? `<img src="${publicUrl}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.8;" alt="${file.name}">` : icon}
                                </div>
                                <div class="card-content">
                                    <h3 class="card-title" style="font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${file.name}">${file.name}</h3>
                                    <p class="card-description">
                                        <small style="color: rgba(255,255,255,0.5);">
                                            ${new Date(file.created_at).toLocaleDateString()} ${new Date(file.created_at).toLocaleTimeString()}
                                            <br>
                                            KB: ${(file.metadata.size / 1024).toFixed(1)}
                                        </small>
                                    </p>
                                    <div class="card-actions">
                                        <a href="${publicUrl}" target="_blank" class="btn-primary" style="flex: 1; text-align: center; text-decoration: none;">Download / Ansehen</a>
                                    </div>
                                </div>
                            `;
                            container.appendChild(card);
                        });

                    } catch (err) {
                        console.error('Error fetching files:', err);
                        container.innerHTML = `<div style="color: #ff4d4d; grid-column: 1/-1;">Fehler beim Laden der Dateien: ${err.message}</div>`;
                    }
                }

                function renderDashboard() {
                    const homeSection = document.getElementById('home');
                    if (!homeSection) return;

                    // Clear and set basic structure
                    homeSection.innerHTML = `
                        <div style="padding-bottom: 2rem;">
                            <h1>Startseite / Dashboard</h1>
                            <p style="color: rgba(255,255,255,0.4); font-family: 'Inter', sans-serif;">Willkommen zurück! Hier ist dein Schnellzugriff.</p>
                        </div>
                        <div id="dashboard-last-viewed">
                            <h2 style="font-size: 1.25rem; color: #fff; margin-bottom: 1.5rem; font-family: 'Inter', sans-serif; display: flex; align-items: center; gap: 10px;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--secondary-green);"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                Zuletzt angesehenen Maschinen (3 Stück)
                            </h2>
                            <div class="card-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(500px, 1fr)); gap: 2rem;">
                                <!-- Cards will be injected here -->
                            </div>
                        </div>
                    `;

                    const cardsContainer = homeSection.querySelector('.card-grid');
                    if (!cardsContainer) return;

                    const lastViewed = (activeUser && activeUser.last_viewed) ? activeUser.last_viewed : [];

                    if (lastViewed.length === 0) {
                        cardsContainer.innerHTML = `
                            <div style="grid-column: 1 / -1; padding: 3rem; text-align: center; background: rgba(255,255,255,0.02); border-radius: 20px; border: 1px dashed rgba(255,255,255,0.1);">
                                <p style="color: rgba(255,255,255,0.3); margin: 0; font-family: 'Inter', sans-serif;">Noch keine Maschinen angesehen. Deine zuletzt besuchten Maschinen erscheinen hier.</p>
                            </div>
                        `;
                        return;
                    }

                    lastViewed.forEach(entry => {
                        const machine = machineList.find(m => m.id === entry.machine_id);
                        if (!machine) return;

                        const viewedAt = new Date(entry.viewed_at);
                        const timeStr = viewedAt.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                        const dateStr = viewedAt.toLocaleDateString('de-DE');

                        const card = document.createElement('div');
                        card.className = 'card';
                        card.style.cssText = 'font-family: \'Inter\', sans-serif; overflow: hidden; display: flex; flex-direction: column; background: rgba(255,255,255,0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer; transition: all 0.3s ease;';
                        card.onclick = () => openMachineDetails(machine.id);

                        const fullTitle = [
                            machine.manufacturer,
                            machine.name,
                            machine.serial ? `#${machine.serial}` : null,
                            machine.year ? `(${machine.year})` : null
                        ].filter(Boolean).join(' ');

                        card.innerHTML = `
                            ${machine.image_url ? `<img src="${machine.image_url}" style="width: 100%; height: 350px; object-fit: cover; display: block; border-bottom: 1px solid rgba(255,255,255,0.1);">` : `
                                <div style="width: 100%; height: 350px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.1;"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                                </div>`}
                            <div style="padding: 2rem; flex: 1; display: flex; flex-direction: column; gap: 1rem;">
                                <h3 style="margin: 0; color: #fff; font-size: 1.8rem; font-weight: 800; word-break: break-word; line-height: 1.2;" title="${fullTitle}">${fullTitle}</h3>
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--secondary-green); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; background: rgba(16, 185, 129, 0.1); padding: 8px 16px; border-radius: 50px; width: fit-content;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                    Zuletzt gesehen am ${dateStr} um ${timeStr}
                                </div>
                            </div>
                        `;
                        cardsContainer.appendChild(card);
                    });
                }

                // ==========================================
                // MACHINE CATEGORY FILTER LOGIC
                // ==========================================
                window.activeMachineCategoryFilters = ['all'];
                window.machineSearchFilter = '';

                function toggleCategoryFilter(event) {
                    event.stopPropagation();
                    const menu = document.getElementById('machine-category-filter-menu');
                    const trigger = document.getElementById('machine-category-filter-trigger');
                    if (!menu || !trigger) return;

                    // Ensure window access for selection
                    window.selectCategoryFilter = selectCategoryFilter;

                    const isShowing = menu.classList.contains('show');

                    // Close user dropdown if open
                    const userDropdown = document.querySelector('.user-dropdown-menu');
                    if (userDropdown) {
                        userDropdown.classList.remove('show');
                        userDropdown.style.display = 'none';
                    }

                    if (isShowing) {
                        menu.classList.remove('show');
                        trigger.classList.remove('active');
                    } else {
                        menu.classList.add('show');
                        trigger.classList.add('active');
                    }
                }

                window.selectCategoryFilter = function (id, name) {
                    console.log('Selecting category filter:', id, name);
                    if (id === 'all') {
                        window.activeMachineCategoryFilters = ['all'];
                    } else {
                        // Remove 'all' if present
                        window.activeMachineCategoryFilters = window.activeMachineCategoryFilters.filter(f => f !== 'all');

                        // Toggle ID
                        const sId = id.toString();
                        const idx = window.activeMachineCategoryFilters.indexOf(sId);
                        if (idx > -1) {
                            window.activeMachineCategoryFilters.splice(idx, 1);
                        } else {
                            window.activeMachineCategoryFilters.push(sId);
                        }

                        // If empty, reset to all
                        if (window.activeMachineCategoryFilters.length === 0) {
                            window.activeMachineCategoryFilters = ['all'];
                        }
                    }

                    // Update Trigger Label
                    const label = document.getElementById('current-category-name');
                    if (label) {
                        if (window.activeMachineCategoryFilters.includes('all')) {
                            label.textContent = 'Maschinenkategorien';
                        } else if (window.activeMachineCategoryFilters.length === 1) {
                            label.textContent = name;
                        } else {
                            const firstCat = categoryList.find(c => c.id.toString() === window.activeMachineCategoryFilters[0].toString());
                            const firstName = firstCat ? firstCat.name : 'Mehrere';
                            label.textContent = `${firstName} +${window.activeMachineCategoryFilters.length - 1}`;
                        }
                    }

                    // Re-render
                    renderCategoryList();
                    renderMachines();

                    // Only close menu if 'all' was selected
                    if (id === 'all') {
                        const menu = document.getElementById('machine-category-filter-menu');
                        const trigger = document.getElementById('machine-category-filter-trigger');
                        if (menu) menu.classList.remove('show');
                        if (trigger) trigger.classList.remove('active');
                    }
                };

                // ==========================================
                // MACHINE CONTACT FILTER LOGIC
                // ==========================================
                window.activeMachineContactFilters = ['all'];

                function toggleContactFilter(event) {
                    event.stopPropagation();
                    const menu = document.getElementById('machine-contact-filter-menu');
                    const trigger = document.getElementById('machine-contact-filter-trigger');
                    if (!menu || !trigger) return;

                    const isShowing = menu.classList.contains('show');

                    // Close other dropdowns
                    const catMenu = document.getElementById('machine-category-filter-menu');
                    const catTrigger = document.getElementById('machine-category-filter-trigger');
                    if (catMenu) catMenu.classList.remove('show');
                    if (catTrigger) catTrigger.classList.remove('active');

                    const userDropdown = document.querySelector('.user-dropdown-menu');
                    if (userDropdown) {
                        userDropdown.classList.remove('show');
                        userDropdown.style.display = 'none';
                    }

                    if (isShowing) {
                        menu.classList.remove('show');
                        trigger.classList.remove('active');
                    } else {
                        menu.classList.add('show');
                        trigger.classList.add('active');
                    }
                }

                window.selectContactFilter = function (id, name) {
                    if (id === 'all') {
                        window.activeMachineContactFilters = ['all'];
                    } else {
                        // Remove 'all' if present
                        window.activeMachineContactFilters = window.activeMachineContactFilters.filter(f => f !== 'all');

                        // Toggle ID
                        const sId = id.toString();
                        const idx = window.activeMachineContactFilters.indexOf(sId);
                        if (idx > -1) {
                            window.activeMachineContactFilters.splice(idx, 1);
                        } else {
                            window.activeMachineContactFilters.push(sId);
                        }

                        // If empty, reset to all
                        if (window.activeMachineContactFilters.length === 0) {
                            window.activeMachineContactFilters = ['all'];
                        }
                    }

                    // Update Trigger Label
                    const label = document.getElementById('current-contact-type-name');
                    if (label) {
                        if (window.activeMachineContactFilters.includes('all')) {
                            label.textContent = 'Art des Kontaktes';
                        } else if (window.activeMachineContactFilters.length === 1) {
                            label.textContent = name;
                        } else {
                            const firstCat = categoryList.find(c => c.id.toString() === window.activeMachineContactFilters[0].toString());
                            const firstName = firstCat ? firstCat.name : 'Mehrere';
                            label.textContent = `${firstName} +${window.activeMachineContactFilters.length - 1}`;
                        }
                    }

                    // Re-render options/machines
                    renderCategoryList();
                    renderMachines();

                    // Only close menu if 'all' was selected
                    if (id === 'all') {
                        const menu = document.getElementById('machine-contact-filter-menu');
                        const trigger = document.getElementById('machine-contact-filter-trigger');
                        if (menu) menu.classList.remove('show');
                        if (trigger) trigger.classList.remove('active');
                    }
                };

                // Global listener for closing overview filters when clicking outside
                document.addEventListener('click', (e) => {
                    const dropdowns = [
                        { menuId: 'machine-category-filter-menu', triggerId: 'machine-category-filter-trigger' },
                        { menuId: 'machine-contact-filter-menu', triggerId: 'machine-contact-filter-trigger' }
                    ];

                    dropdowns.forEach(({ menuId, triggerId }) => {
                        const menu = document.getElementById(menuId);
                        const trigger = document.getElementById(triggerId);
                        if (menu && menu.classList.contains('show') &&
                            !trigger.contains(e.target) && !menu.contains(e.target)) {
                            menu.classList.remove('show');
                            trigger.classList.remove('active');
                        }
                    });
                });

                // Machine Search Listener
                const machineSearchInput = document.getElementById('machine-search-input');
                if (machineSearchInput) {
                    machineSearchInput.addEventListener('input', (e) => {
                        window.machineSearchFilter = e.target.value;
                        renderMachines();
                    });
                }

                // ==========================================
                // USER MANAGEMENT LOGIC
                // ==========================================
                let userList = [];

                async function fetchUsers() {
                    if (!supabaseClient) return;

                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: true });

                    if (error) {
                        console.error('Error fetching users:', error);
                        return;
                    }

                    userList = data || [];
                    window.userList = userList; // Ensure global access for service report
                    renderUserList();

                    // Init Switcher
                    renderUserDropdown();

                    // Update global list for service report if needed
                    if (typeof renderServiceTechnicianList === 'function') {
                        renderServiceTechnicianList();
                    }

                    // Restore Active User
                    const savedId = localStorage.getItem('activeUserId');
                    if (savedId) {
                        const user = userList.find(u => u.id == savedId);
                        if (user) setActiveUser(user.id);
                    } else if (userList.length > 0) {
                        setActiveUser(userList[0].id);
                    }

                    // Re-render service entries if on that view, as they depend on userList for technicians dropdown
                    const serviceView = document.getElementById('service');
                    if (serviceView && !serviceView.classList.contains('hidden')) {
                        if (typeof renderServiceEntries === 'function') renderServiceEntries();
                    }
                }


                function renderUserList() {
                    const listContainer = document.getElementById('user-list');
                    if (!listContainer) return;

                    listContainer.innerHTML = '';

                    userList.forEach(user => {
                        const li = document.createElement('li');
                        li.className = 'user-item';
                        // Set CSS variable for the border and avatar color
                        li.style.setProperty('--user-color', user.color || '#999');

                        li.innerHTML = `
                            <div class="user-item-content">
                                <div class="user-info-group">
                                    <div class="user-avatar-large" style="position: relative; cursor: pointer;" onclick="document.getElementById('color-picker-${user.id}').click()" title="Farbe ändern">
                                        ${user.initials || user.name.substring(0, 2).toUpperCase()}
                                        <input type="color" id="color-picker-${user.id}" 
                                               style="position: absolute; opacity: 0; width: 0; height: 0; bottom: 0; right: 0;"
                                               value="${user.color || '#999999'}"
                                               onchange="updateUserColor(${user.id}, this.value)">
                                    </div>
                                    <div class="user-details" style="display: flex; align-items: center;">
                                        <span class="user-name-link">${user.name}</span>
                                    </div>
                                </div>
                                <div class="user-actions">
                                    <button class="btn-icon-soft edit" onclick="editUser(${user.id})" title="Bearbeiten">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <button class="btn-icon-soft delete" onclick="deleteUser(${user.id})" title="Löschen">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M3 6h18"></path>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `;
                        listContainer.appendChild(li);
                    });
                }

                // Helper for random color
                function getRandomColor() {
                    const colors = ['#D32F2F', '#2ecc71', '#FFA000', '#1976D2', '#9C27B0'];
                    return colors[Math.floor(Math.random() * colors.length)];
                }

                // Expose functions to global scope
                window.updateUserColor = async function (id, newColor) {
                    // Optimistic update
                    const user = userList.find(u => u.id === id);
                    if (user) {
                        user.color = newColor;
                        renderUserList(); // Re-render to show update immediately
                    }

                    console.log('Updating user color in Supabase:', { id, newColor });
                    const { error } = await supabaseClient
                        .from('users')
                        .update({ color: newColor })
                        .eq('id', id);

                    if (error) {
                        console.error('Supabase Error (updateUserColor):', error);
                        alert('Fehler beim Speichern der Farbe: ' + (error.message || JSON.stringify(error)));
                        fetchUsers(); // Revert on failure
                    } else {
                        console.log('User color updated successfully');
                    }
                };

                window.editUser = async function (id) {
                    if (!supabaseClient) { alert('Datenbank nicht verbunden'); return; }
                    const user = userList.find(u => u.id === id);
                    if (user) {
                        const newName = prompt('Name bearbeiten:', user.name);
                        if (newName && newName !== user.name) {
                            const initials = newName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

                            console.log('Updating user name/initials:', { id, newName, initials });
                            const { error } = await supabaseClient
                                .from('users')
                                .update({
                                    name: newName,
                                    initials: initials,
                                    role: 'Kürzel: ' + initials
                                })
                                .eq('id', id);

                            if (error) {
                                console.error('Supabase Error (editUser):', error);
                                alert('Fehler beim Aktualisieren: ' + (error.message || JSON.stringify(error)));
                            } else {
                                console.log('User updated successfully');
                                fetchUsers();
                            }
                        }
                    }
                };

                window.deleteUser = async function (id) {
                    if (!supabaseClient) { alert('Datenbank nicht verbunden'); return; }
                    if (confirm('Benutzer wirklich löschen?')) {
                        console.log('Deleting user:', id);
                        const { error } = await supabaseClient
                            .from('users')
                            .delete()
                            .eq('id', id);

                        if (error) {
                            console.error('Supabase Error (deleteUser):', error);
                            alert('Fehler beim Löschen: ' + (error.message || JSON.stringify(error)));
                        } else {
                            console.log('User deleted successfully');
                            fetchUsers();
                        }
                    }
                };

                // Add User Button
                const addUserBtn = document.getElementById('add-user-btn');
                if (addUserBtn) {
                    // Remove old listeners to avoid duplicates if re-running script (though unlikely here)
                    const newBtn = addUserBtn.cloneNode(true);
                    addUserBtn.parentNode.replaceChild(newBtn, addUserBtn);

                    newBtn.addEventListener('click', async () => {
                        if (!supabaseClient) { alert('Datenbank nicht verbunden'); return; }
                        const name = prompt('Name des neuen Benutzers:');
                        if (name) {
                            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                            const newUser = {
                                name: name,
                                initials: initials,
                                role: 'Kürzel: ' + initials,
                                color: getRandomColor()
                            };
                            const { error } = await supabaseClient
                                .from('users')
                                .insert([newUser]);

                            if (error) {
                                alert('Fehler beim Anlegen: ' + error.message);
                            } else {
                                fetchUsers();
                            }
                        }
                    });
                }

                // Initial Render (already called in fetchUsers, but safe to keep or remove. fetchUsers() call in DOMContentLoaded is key)
                // renderUserList(); // Removed to avoid double render empty then full

                // ==========================================
                // CATEGORY MANAGEMENT LOGIC
                // ==========================================
                let categoryList = [];

                async function fetchCategories() {
                    if (!supabaseClient) return;

                    const { data, error } = await supabaseClient
                        .from('categories')
                        .select('*')
                        .order('name', { ascending: true });

                    if (error) {
                        console.error('Error fetching categories:', error);
                        return;
                    }

                    categoryList = data || [];
                    window.categoryList = categoryList; // GLOBAL EXPOSURE
                    renderCategoryList();

                    // Re-render machines to ensure category names are correctly resolved
                    if (typeof renderMachines === 'function') {
                        renderMachines();
                    }
                }

                window.renderCategoryList = function () {
                    const listMachine = document.getElementById('category-list-machine');
                    const listService = document.getElementById('category-list-service');
                    const listContact = document.getElementById('category-list-contact');

                    // Safety check
                    if (!listMachine || !listService) return;

                    listMachine.innerHTML = '';
                    listService.innerHTML = '';
                    if (listContact) listContact.innerHTML = '';

                    // Populate custom machine category filter dropdown
                    const filterOptionsList = document.getElementById('machine-category-filter-options');
                    if (filterOptionsList) {
                        filterOptionsList.innerHTML = '';

                        // Option: Maschinenkategorien
                        const allLi = document.createElement('li');
                        allLi.textContent = 'Maschinenkategorien';
                        allLi.setAttribute('data-id', 'all');
                        if (window.activeMachineCategoryFilters.includes('all')) allLi.classList.add('selected');
                        allLi.addEventListener('click', (e) => {
                            e.stopPropagation();
                            window.selectCategoryFilter('all', 'Maschinenkategorien');
                        });
                        filterOptionsList.appendChild(allLi);

                        categoryList.filter(c => c.type === 'machine').forEach(cat => {
                            const li = document.createElement('li');
                            li.setAttribute('data-id', cat.id);

                            const isSelected = window.activeMachineCategoryFilters.includes(cat.id.toString()) || window.activeMachineCategoryFilters.includes(cat.id);
                            if (isSelected) li.classList.add('selected');

                            li.innerHTML = `
                                <span>${cat.name}</span>
                                ${isSelected ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' : ''}
                            `;

                            li.addEventListener('click', (e) => {
                                e.stopPropagation();
                                window.selectCategoryFilter(cat.id, cat.name);
                            });
                            filterOptionsList.appendChild(li);
                        });
                    }

                    // Populate custom contact type filter dropdown
                    const contactFilterOptionsList = document.getElementById('machine-contact-filter-options');
                    if (contactFilterOptionsList) {
                        contactFilterOptionsList.innerHTML = '';

                        // Option: Alle Kontaktarten
                        const allLi = document.createElement('li');
                        allLi.textContent = 'Alle Kontaktarten';
                        allLi.setAttribute('data-id', 'all');
                        if (window.activeMachineContactFilters.includes('all')) allLi.classList.add('selected');
                        allLi.addEventListener('click', (e) => {
                            e.stopPropagation();
                            window.selectContactFilter('all', 'Art des Kontaktes');
                        });
                        contactFilterOptionsList.appendChild(allLi);

                        categoryList.filter(c => c.type === 'contact').forEach(cat => {
                            const li = document.createElement('li');
                            li.setAttribute('data-id', cat.id);

                            const isSelected = window.activeMachineContactFilters.includes(cat.id.toString()) || window.activeMachineContactFilters.includes(cat.id);
                            if (isSelected) li.classList.add('selected');

                            li.innerHTML = `
                                <span>${cat.name}</span>
                                ${isSelected ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' : ''}
                            `;

                            li.addEventListener('click', (e) => {
                                e.stopPropagation();
                                window.selectContactFilter(cat.id, cat.name);
                            });
                            contactFilterOptionsList.appendChild(li);
                        });
                    }

                    categoryList.forEach(cat => {
                        const li = document.createElement('li');
                        li.className = 'user-item';

                        // Determine type and styling
                        let savedColor, accentColor;

                        // Default colors
                        const colors = {
                            machine: '#e67e22',
                            service: '#2980b9',
                            contact: '#9b59b6'
                        };

                        const type = cat.type || 'machine';
                        savedColor = localStorage.getItem(`cat_group_color_${type}`);
                        accentColor = savedColor || colors[type] || '#999';

                        li.style.setProperty('--user-color', accentColor);

                        li.innerHTML = `
                            <div class="user-item-content">
                                    <div class="user-details" style="display: flex; align-items: center; justify-content: space-between; padding-left: 0.5rem; width: 100%;">
                                        <span class="user-name-link" style="color: ${accentColor}; font-weight: 700; font-family: 'Inter', sans-serif; font-size: 1.1rem;">${cat.name}</span>
                                        ${type === 'machine' ? `<span style="font-size: 0.85rem; color: rgba(255,255,255,0.4); font-weight: 600; padding-right: 1rem;">Intervall: ${cat.default_maintenance_interval_months || 12}M</span>` : ''}
                                    </div>
                                <div class="user-actions">
                                    <button class="btn-icon-soft edit" onclick="editCategory(${cat.id})" title="Bearbeiten">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    </button>
                                    <button class="btn-icon-soft delete" onclick="deleteCategory(${cat.id})" title="Löschen">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"></path></svg>
                                    </button>
                                </div>
                            </div>
                        `;

                        if (type === 'machine') {
                            listMachine.appendChild(li);
                        } else if (type === 'service') {
                            listService.appendChild(li);
                        } else if (type === 'contact' && listContact) {
                            listContact.appendChild(li);
                        }
                    });
                }

                window.editCategory = async function (id) {
                    if (!supabaseClient) { alert('Datenbank nicht verbunden'); return; }
                    const cat = categoryList.find(c => c.id === id);
                    if (cat) {
                        const newName = prompt('Kategorie umbenennen:', cat.name);
                        if (newName === null) return; // Cancelled

                        let interval = cat.default_maintenance_interval_months;
                        if (cat.type === 'machine') {
                            const newInterval = prompt('Wartungsintervall (Monate):', cat.default_maintenance_interval_months || 12);
                            if (newInterval !== null) interval = parseInt(newInterval) || 12;
                        }

                        const updateData = { name: newName };
                        if (cat.type === 'machine') updateData.default_maintenance_interval_months = interval;

                        const { error } = await supabaseClient
                            .from('categories')
                            .update(updateData)
                            .eq('id', id);

                        if (error) {
                            alert('Fehler: ' + error.message);
                        } else {
                            fetchCategories();
                        }
                    }
                };

                window.deleteCategory = async function (id) {
                    if (!supabaseClient) { alert('Datenbank nicht verbunden'); return; }
                    if (confirm('Kategorie wirklich löschen?')) {
                        const { error } = await supabaseClient
                            .from('categories')
                            .delete()
                            .eq('id', id);

                        if (error) {
                            alert('Fehler: ' + error.message);
                        } else {
                            fetchCategories();
                        }
                    }
                };

                // CATEGORY MODAL LOGIC
                const addCatBtn = document.getElementById('add-category-btn');
                const catModal = document.getElementById('category-modal');
                const cancelCatBtn = document.getElementById('cancel-cat-btn');
                const saveCatBtn = document.getElementById('save-cat-btn');
                const catNameInput = document.getElementById('cat-name-input');
                const catIntervalInput = document.getElementById('cat-interval-input');
                const catIntervalGroup = document.getElementById('cat-interval-group');
                const catTypeRadios = document.getElementsByName('cat-type');
                const catModalId = document.getElementById('cat-modal-id');
                const catModalTitle = document.getElementById('cat-modal-title');

                // Toggle interval field visibility
                catTypeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        if (catIntervalGroup) {
                            catIntervalGroup.style.display = e.target.value === 'machine' ? 'block' : 'none';
                        }
                    });
                });

                function openModal(editData = null) {
                    if (catModal) {
                        // Reset form
                        if (catModalId) catModalId.value = editData ? editData.id : '';
                        if (catModalTitle) catModalTitle.textContent = editData ? 'Kategorie bearbeiten' : 'Neue Kategorie';

                        if (catNameInput) catNameInput.value = editData ? editData.name : '';
                        if (catIntervalInput) catIntervalInput.value = editData ? (editData.default_maintenance_interval_months || 12) : 12;

                        if (editData && catTypeRadios) {
                            catTypeRadios.forEach(r => {
                                r.checked = (r.value === editData.type);
                                if (r.checked && r.value === 'machine' && catIntervalGroup) {
                                    catIntervalGroup.style.display = 'block';
                                } else if (r.checked && catIntervalGroup) {
                                    catIntervalGroup.style.display = 'none';
                                }
                            });
                        } else if (!editData && catTypeRadios) {
                            catTypeRadios[0].checked = true; // Default to machine
                            if (catIntervalGroup) catIntervalGroup.style.display = 'block';
                        }

                        catModal.classList.remove('hidden');
                        catModal.style.display = 'flex';
                        requestAnimationFrame(() => {
                            catModal.classList.add('show');
                        });
                        if (catNameInput && !editData) {
                            catNameInput.focus();
                        }
                    }
                }

                function closeModal() {
                    if (catModal) {
                        catModal.classList.remove('show');
                        setTimeout(() => {
                            catModal.classList.add('hidden');
                            catModal.style.display = 'none';
                        }, 300);
                    }
                }

                if (cancelCatBtn) {
                    cancelCatBtn.addEventListener('click', closeModal);
                }

                if (saveCatBtn) {
                    // Clone to remove old listeners
                    const newBtn = saveCatBtn.cloneNode(true);
                    saveCatBtn.parentNode.replaceChild(newBtn, saveCatBtn);

                    newBtn.addEventListener('click', async () => {
                        if (!supabaseClient) { alert('Datenbank nicht verbunden'); return; }

                        const name = catNameInput ? catNameInput.value.trim() : '';
                        if (!name) {
                            alert('Bitte einen Namen eingeben.');
                            return;
                        }

                        let typeValue = 'machine';
                        if (catTypeRadios) {
                            for (const radio of catTypeRadios) {
                                if (radio.checked) { typeValue = radio.value; break; }
                            }
                        }

                        const intervalValue = typeValue === 'machine' ? parseInt(catIntervalInput.value) || 12 : null;
                        const editingId = catModalId ? catModalId.value : '';

                        const payload = {
                            name: name,
                            type: typeValue,
                            default_maintenance_interval_months: intervalValue
                        };

                        let response;
                        if (editingId) {
                            // Check for interval change
                            const oldCat = (window.categoryList || []).find(c => c.id == editingId);
                            const intervalChanged = oldCat && oldCat.default_maintenance_interval_months !== intervalValue;

                            // UPDATE
                            response = await supabaseClient
                                .from('categories')
                                .update(payload)
                                .eq('id', editingId);

                            if (!response.error && intervalChanged && typeValue === 'machine') {
                                console.log('Interval changed, updating affected machines...');
                                await updateAffectedMachines(editingId, intervalValue);
                            }
                        } else {
                            // INSERT
                            response = await supabaseClient
                                .from('categories')
                                .insert([payload]);
                        }

                        if (response.error) {
                            alert('Fehler: ' + response.error.message);
                        } else {
                            closeModal();
                            fetchCategories();
                            if (typeof fetchMachines === 'function') fetchMachines();
                        }
                    });
                }

                async function updateAffectedMachines(categoryId, newInterval) {
                    try {
                        const oldCat = (window.categoryList || []).find(c => c.id == categoryId);
                        const oldInterval = oldCat ? (oldCat.default_maintenance_interval_months || 12) : 12;

                        const { data: machines, error } = await supabaseClient
                            .from('machines')
                            .select('id, last_maintenance, next_maintenance, files')
                            .eq('category_id', categoryId);

                        if (error) throw error;
                        if (!machines || machines.length === 0) return;

                        for (const m of machines) {
                            if (!m.last_maintenance) continue;

                            // Check if it's currently considered "AUTO" OR if it matches the old logic (migration)
                            const isAuto = Array.isArray(m.files) && m.files.some(f => f.type === 'meta' && f.key === 'is_next_maintenance_auto' && f.property === 'true');

                            // Heuristic migration: if next_maintenance matches last + oldInterval, it was likely auto-calculated
                            let shouldUpdate = isAuto;
                            if (!isAuto && m.next_maintenance) {
                                const last = new Date(m.last_maintenance);
                                const next = new Date(m.next_maintenance);
                                const expectedNext = new Date(last);
                                expectedNext.setMonth(expectedNext.getMonth() + parseInt(oldInterval));
                                if (next.toISOString().split('T')[0] === expectedNext.toISOString().split('T')[0]) {
                                    shouldUpdate = true;
                                }
                            }

                            if (shouldUpdate) {
                                const lastParts = m.last_maintenance.split('-');
                                const lastDate = new Date(lastParts[0], lastParts[1] - 1, lastParts[2]);
                                lastDate.setMonth(lastDate.getMonth() + parseInt(newInterval));

                                const yyyy = lastDate.getFullYear();
                                const mm = String(lastDate.getMonth() + 1).padStart(2, '0');
                                const dd = String(lastDate.getDate()).padStart(2, '0');
                                const nextDateStr = `${yyyy}-${mm}-${dd}`;

                                // Update machine and ensure meta is set
                                let finalFiles = m.files ? [...m.files] : [];
                                finalFiles = finalFiles.filter(f => f.type !== 'meta' || f.key !== 'is_next_maintenance_auto');
                                finalFiles.push({ type: 'meta', key: 'is_next_maintenance_auto', property: 'true' });

                                await supabaseClient
                                    .from('machines')
                                    .update({
                                        next_maintenance: nextDateStr,
                                        files: finalFiles
                                    })
                                    .eq('id', m.id);
                            }
                        }
                    } catch (err) {
                        console.error('Error in updateAffectedMachines:', err);
                    }
                }

                // --- Calendar Interaction Handlers ---
                window.handleCalendarDragStart = function (event, machineId) {
                    event.dataTransfer.setData('text/plain', machineId);
                    if (event.target) event.target.style.opacity = '0.5';
                };

                let calendarNavPendingMachineId = null;

                window.handleCalendarEventClick = function (machineId) {
                    const event = window.event;
                    if (!event) return;

                    calendarNavPendingMachineId = machineId;

                    const popover = document.getElementById('calendar-nav-popover');
                    if (!popover) return;

                    // Position popover near click
                    const x = Math.min(event.clientX, window.innerWidth - 300);
                    const y = Math.min(event.clientY, window.innerHeight - 200);

                    popover.style.left = x + 'px';
                    popover.style.top = y + 'px';
                    popover.classList.add('active');

                    // Stop propagation to prevent immediate close from document listener
                    event.stopPropagation();
                };

                window.closeCalendarNavPopover = function () {
                    const popover = document.getElementById('calendar-nav-popover');
                    if (popover) popover.classList.remove('active');
                    calendarNavPendingMachineId = null;
                };

                window.confirmCalendarNavigation = function () {
                    if (!calendarNavPendingMachineId) return;

                    const machine = (window.machineList || []).find(m => m.id == calendarNavPendingMachineId);

                    // Switch to machines view
                    if (typeof window.switchView === 'function') {
                        window.switchView('machines');
                    }

                    // Apply Search Filter automatically (highly specific, matches title format)
                    const searchInput = document.getElementById('machine-search-input');
                    if (machine) {
                        const machineTitle = [
                            machine.manufacturer,
                            machine.name,
                            machine.serial ? `#${machine.serial}` : null,
                            machine.year ? `(${machine.year})` : null
                        ].filter(Boolean).join(' ');

                        // Update global filter state
                        window.machineSearchFilter = machineTitle;

                        // Update UI
                        if (searchInput) {
                            searchInput.value = machineTitle;
                        }

                        // Trigger re-render of machines list based on new search value
                        if (typeof window.renderMachines === 'function') {
                            window.renderMachines();
                        }
                    }

                    // Open modal
                    if (typeof window.openEditStammdaten === 'function') {
                        setTimeout(() => {
                            window.openEditStammdaten(calendarNavPendingMachineId);
                            window.closeCalendarNavPopover();
                        }, 100);
                    }
                };

                // Close popover on click outside
                document.addEventListener('click', (e) => {
                    const popover = document.getElementById('calendar-nav-popover');
                    if (popover && !popover.contains(e.target)) {
                        window.closeCalendarNavPopover();
                    }
                });

                window.handleCalendarDrop = async function (event, dateStr) {
                    event.preventDefault();
                    if (event.currentTarget) event.currentTarget.style.background = '';
                    const machineId = event.dataTransfer.getData('text/plain');
                    if (!machineId) return;

                    // Reset opacity for all pills (simplest way since we don't track the element easily)
                    document.querySelectorAll('.calendar-event-pill').forEach(p => p.style.opacity = '1');

                    if (!supabaseClient) return;

                    try {
                        const m = (window.machineList || []).find(mm => mm.id == machineId);
                        if (!m) return;

                        // dateStr is already YYYY-MM-DD from the ondrop attribute
                        const finalDateStr = dateStr;

                        // Remove "AUTO" flag when manually dragged
                        let updatedFiles = Array.isArray(m.files) ? [...m.files] : [];
                        updatedFiles = updatedFiles.filter(f => f.type !== 'meta' || f.key !== 'is_next_maintenance_auto');

                        const { error } = await supabaseClient
                            .from('machines')
                            .update({
                                next_maintenance: finalDateStr,
                                files: updatedFiles
                            })
                            .eq('id', machineId);

                        if (error) throw error;

                        // Update local state
                        m.next_maintenance = finalDateStr;
                        m.files = updatedFiles;

                        // Re-render
                        if (typeof renderCalendar === 'function') renderCalendar();
                        if (typeof renderMachines === 'function') renderMachines();

                        // Also update dashboard if visible
                        const homeView = document.getElementById('home');
                        if (homeView && !homeView.classList.contains('hidden') && typeof renderDashboard === 'function') {
                            renderDashboard();
                        }

                        console.log(`Updated machine ${machineId} to ${finalDateStr} (Manual Move)`);
                    } catch (err) {
                        console.error('Error updating maintenance date via calendar:', err);
                        alert('Fehler beim Aktualisieren des Datums.');
                    }
                };

                // Add Category Button Listener (Open Modal)
                if (addCatBtn) {
                    const newBtn = addCatBtn.cloneNode(true);
                    addCatBtn.parentNode.replaceChild(newBtn, addCatBtn);
                    newBtn.addEventListener('click', () => openModal());
                }

                window.editCategory = function (id) {
                    const cat = (window.categoryList || []).find(c => c.id === id);
                    if (cat) {
                        openModal(cat);
                    }
                };


                // ==========================================
                // MACHINES MANAGEMENT LOGIC
                // ==========================================
                let machineList = [];

                async function fetchMachines() {
                    if (!supabaseClient) return;

                    const { data, error } = await supabaseClient
                        .from('machines')
                        .select('*')
                        .order('created_at', { ascending: true });

                    if (error) {
                        console.error('Error fetching machines:', error);
                        return;
                    }

                    machineList = data || [];
                    window.machineList = machineList; // GLOBAL EXPOSURE
                    renderMachines();

                    // Refresh dashboard if on home view
                    const homeView = document.getElementById('home');
                    if (homeView && !homeView.classList.contains('hidden')) {
                        renderDashboard();
                    }

                    // Re-render service entries if on that view, as they depend on machineList
                    const serviceView = document.getElementById('service');
                    if (serviceView && !serviceView.classList.contains('hidden')) {
                        if (typeof renderServiceEntries === 'function') renderServiceEntries();
                    }

                    // Refresh calendar as well
                    if (typeof renderCalendar === 'function') {
                        renderCalendar();
                    }
                }


                function renderMachines() {
                    const container = document.querySelector('#machines .card-grid');
                    if (!container) return;

                    const catFilters = window.activeMachineCategoryFilters;
                    const conFilters = window.activeMachineContactFilters;

                    container.innerHTML = '';

                    const filteredMachines = machineList.filter(m => {
                        // Category Filter: Match if 'all' is selected or machine's category is in list
                        const matchCat = catFilters.includes('all') ||
                            (m.category_id && catFilters.includes(m.category_id.toString()));

                        // Contact Type Filter: Match if 'all' is selected or machine shares any type with filters
                        let matchCon = conFilters.includes('all');
                        if (!matchCon && m.contact_type) {
                            try {
                                const machineTypes = Array.isArray(m.contact_type) ? m.contact_type : JSON.parse(m.contact_type);
                                // Check if any machine contact type is in the active filters array
                                matchCon = machineTypes.some(t => conFilters.includes(t.toString()));
                            } catch (e) {
                                console.warn('Failed to parse contact_type for machine', m.id, e);
                            }
                        }

                        // Search Keyword Filter (multi-term support)
                        let matchSearch = true;
                        if (window.machineSearchFilter && window.machineSearchFilter.trim() !== '') {
                            const queryTerms = window.machineSearchFilter.toLowerCase().trim().split(/\s+/);
                            const searchableText = [
                                m.name,
                                m.manufacturer,
                                m.serial ? `#${m.serial}` : '',
                                m.year ? `(${m.year})` : ''
                            ].join(' ').toLowerCase();

                            // Every term must be present in the searchable text
                            matchSearch = queryTerms.every(term => searchableText.includes(term));
                        }

                        return matchCat && matchCon && matchSearch;
                    });

                    // Group machines by category
                    const groupedByCategory = {};
                    filteredMachines.forEach(machine => {
                        const catId = machine.category_id || 'uncategorized';
                        if (!groupedByCategory[catId]) {
                            groupedByCategory[catId] = [];
                        }
                        groupedByCategory[catId].push(machine);
                    });

                    // Sort each category's machines by serial number (descending)
                    Object.keys(groupedByCategory).forEach(catId => {
                        groupedByCategory[catId].sort((a, b) => {
                            const serialA = parseInt(a.serial) || 0;
                            const serialB = parseInt(b.serial) || 0;
                            return serialB - serialA; // Descending
                        });

                        // Debug: Log grouped categories
                        console.log('Grouped categories:', Object.keys(groupedByCategory));
                        console.log('Available categories:', categoryList);
                    });

                    // Get sorted category list (alphabetically by name)
                    const sortedCategories = Object.keys(groupedByCategory).sort((a, b) => {
                        let nameA = 'Unkategorisiert';
                        let nameB = 'Unkategorisiert';

                        if (a !== 'uncategorized') {
                            const catA = categoryList.find(c => c.id == a); // Use == for string/number comparison
                            if (catA) nameA = catA.name;
                        }

                        if (b !== 'uncategorized') {
                            const catB = categoryList.find(c => c.id == b); // Use == for string/number comparison
                            if (catB) nameB = catB.name;
                        }

                        return nameA.localeCompare(nameB);
                    });

                    // Render each category with collapsible header
                    sortedCategories.forEach(catId => {
                        const machines = groupedByCategory[catId];

                        // Handle both numeric category IDs and 'uncategorized' string
                        let cat = null;
                        let catName = 'Unkategorisiert';
                        let catColor = '#666';

                        if (catId !== 'uncategorized') {
                            // Try to find the category by ID
                            cat = categoryList.find(c => c.id == catId); // Use == to handle string/number comparison
                            if (cat) {
                                catName = cat.name;
                                catColor = cat.color || '#3b82f6';
                            }
                        }

                        // Create category section
                        const categorySection = document.createElement('div');
                        categorySection.className = 'category-section';
                        categorySection.style.cssText = 'grid-column: 1 / -1; margin-bottom: 1.5rem;';

                        // Category header (collapsible)
                        const categoryHeader = document.createElement('div');
                        categoryHeader.className = 'category-header';
                        categoryHeader.style.cssText = `
                            background: rgba(255,255,255,0.03);
                            backdrop-filter: blur(16px);
                            border: 1px solid rgba(255,255,255,0.1);
                            border-radius: 14px;
                            padding: 1rem 1.5rem;
                            margin-bottom: 1rem;
                            cursor: pointer;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            transition: all 0.2s;
                            user-select: none;
                        `;
                        categoryHeader.onmouseover = () => {
                            categoryHeader.style.background = 'rgba(255,255,255,0.05)';
                            categoryHeader.style.borderColor = 'rgba(255,255,255,0.15)';
                        };
                        categoryHeader.onmouseout = () => {
                            categoryHeader.style.background = 'rgba(255,255,255,0.03)';
                            categoryHeader.style.borderColor = 'rgba(255,255,255,0.1)';
                        };

                        const sectionId = `category-machines-${catId}`;
                        const iconId = `category-icon-${catId}`;

                        categoryHeader.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="width: 4px; height: 24px; background: ${catColor}; border-radius: 2px;"></div>
                                <h3 style="margin: 0; font-size: 1.2rem; font-weight: 800; color: #fff; font-family: 'Inter', sans-serif;">
                                    ${catName}
                                </h3>
                                <span style="background: rgba(255,255,255,0.1); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 700; color: rgba(255,255,255,0.6);">
                                    ${machines.length}
                                </span>
                            </div>
                            <svg id="${iconId}" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="transition: transform 0.3s; color: rgba(255,255,255,0.4);">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        `;

                        categoryHeader.onclick = () => {
                            const content = document.getElementById(sectionId);
                            const icon = document.getElementById(iconId);

                            if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
                                // Open
                                content.style.maxHeight = content.scrollHeight + 'px';
                                content.style.opacity = '1';
                                content.style.marginTop = '0';
                                if (icon) icon.style.transform = 'rotate(0deg)';
                                // Update max-height after transition to allow dynamic content
                                setTimeout(() => {
                                    if (content.style.maxHeight !== '0px') {
                                        content.style.maxHeight = 'none';
                                    }
                                }, 400);
                            } else {
                                // Close
                                content.style.maxHeight = content.scrollHeight + 'px';
                                requestAnimationFrame(() => {
                                    content.style.maxHeight = '0px';
                                    content.style.opacity = '0';
                                    content.style.marginTop = '-1rem';
                                });
                                if (icon) icon.style.transform = 'rotate(-90deg)';
                            }
                        };

                        // Category content (grid of machine cards)
                        const categoryContent = document.createElement('div');
                        categoryContent.id = sectionId;
                        categoryContent.className = 'category-content';
                        categoryContent.style.cssText = `
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
                            gap: 1.5rem;
                            max-height: none;
                            overflow: hidden;
                            transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
                            opacity: 1;
                            margin-top: 0;
                        `;

                        // Render machine cards for this category
                        machines.forEach(machine => {
                            // Find category name
                            const cat = categoryList.find(c => c.id === machine.category_id);
                            const catName = cat ? cat.name : 'Unkategorisiert';

                            // --- Build Card HTML ---
                            const card = document.createElement('div');
                            card.className = 'card';
                            card.style.cssText = 'font-family: \'Inter\', sans-serif; overflow: hidden; display: flex; flex-direction: column; background: rgba(255,255,255,0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer;';
                            card.onclick = () => window.openEditStammdaten(machine.id);

                            let statusClass = 'status-default';
                            if (machine.status === 'Wartung erforderlich') statusClass = 'status-warning';
                            if (machine.status === 'Defekt') statusClass = 'status-danger';

                            // Image logic
                            let imageHtml = '';
                            if (machine.image_url) {
                                imageHtml = `<img src="${machine.image_url}" alt="${machine.name}" style="width: 100%; height: 300px; object-fit: cover; display: block; border-bottom: 1px solid rgba(255,255,255,0.1);">`;
                            } else {
                                imageHtml = `
                                <div class="card-image-placeholder" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01)); color: rgba(255,255,255,0.2); height: 300px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.4;">
                                        <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                                        <circle cx="9" cy="9" r="2"/>
                                        <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                                    </svg>
                                </div>`;
                            }


                            // Maintenance logic
                            const lastMaintDate = machine.last_maintenance ? new Date(machine.last_maintenance).toLocaleDateString('de-DE') : 'Keine Daten';
                            const nextMaintDate = machine.next_maintenance ? new Date(machine.next_maintenance) : null;
                            const nextMaintStr = nextMaintDate ? nextMaintDate.toLocaleDateString('de-DE') : 'Kein Termin';

                            // Check if next maintenance was auto-calculated
                            const isAuto = Array.isArray(machine.files) && machine.files.some(f => f.type === 'meta' && f.key === 'is_next_maintenance_auto' && f.property === 'true');
                            const autoBadge = isAuto ? `<span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); font-size: 0.65rem; padding: 1px 5px; border-radius: 4px; font-weight: 800; margin-left: 8px; vertical-align: middle;">AUTO</span>` : '';

                            // Determine status color for urgency
                            let maintStatusColor = '#10b981'; // Default Green (OK)
                            let maintStatusText = 'Aktuell';

                            if (nextMaintDate) {
                                const now = new Date();
                                const diffDays = Math.ceil((nextMaintDate - now) / (1000 * 60 * 60 * 24));

                                if (diffDays < 0) {
                                    maintStatusColor = '#ef4444'; // Red (Overdue)
                                    maintStatusText = 'Überfällig';
                                } else if (diffDays <= 30) {
                                    maintStatusColor = '#f59e0b'; // Yellow/Orange (Due soon)
                                    maintStatusText = 'Bald fällig';
                                }
                            }

                            card.innerHTML = `
                            ${imageHtml}
                            <div class="card-content" style="padding: 1.75rem; flex: 1; display: flex; flex-direction: column;">
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="flex: 1; overflow: hidden;">
                                        <h2 class="card-title" style="margin: 0; font-size: 2.0rem; color: #fff; font-weight: 800; line-height: 1.3; font-family: 'Inter', sans-serif;">
                                            ${[
                                    machine.manufacturer,
                                    machine.name,
                                    machine.serial ? `#${machine.serial}` : null,
                                    machine.year ? `(${machine.year})` : null
                                ].filter(Boolean).join(' ')}
                                        </h2>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; margin-bottom: 1.75rem; background: rgba(0,0,0,0.15); padding: 18px 1.75rem; border-radius: 14px; border: 1px solid rgba(255,255,255,0.06); margin-left: -1.75rem; margin-right: -1.75rem; position: relative;">
                                    <div style="border-right: 1px solid rgba(255,255,255,0.05); padding-right: 12px;">
                                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.4); margin-bottom: 5px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Letzte Wartung</div>
                                        <div style="font-size: 1.05rem; color: #fff; display: flex; align-items: center; gap: 6px; font-weight: 700;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color: rgba(255,255,255,0.4);"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                            ${lastMaintDate}
                                        </div>
                                    </div>
                                    <div style="padding-left: 6px;">
                                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.4); margin-bottom: 5px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Nächste Wartung</div>
                                        <div style="font-size: 1.05rem; color: ${maintStatusColor}; display: flex; align-items: center; gap: 6px; font-weight: 700;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color: ${maintStatusColor};"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                            ${nextMaintStr}${autoBadge}
                                        </div>
                                    </div>
                                    <div style="position: absolute; top: -10px; right: 20px; background: ${maintStatusColor}; color: #fff; font-size: 0.7rem; font-weight: 900; padding: 2px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                        ${maintStatusText}
                                    </div>
                                </div>
                                    <div style="padding-left: 6px; cursor: pointer;" onclick="event.stopPropagation(); window.open('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent('${machine.location || ''}'), '_blank')">
                                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.4); margin-bottom: 5px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Standort</div>
                                        <div style="font-size: 1.05rem; color: #fff; display: flex; align-items: start; gap: 6px; font-weight: 600;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color: #3b82f6; margin-top: 3px; flex-shrink: 0;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                            <span style="word-break: break-word; line-height: 1.4;">${machine.location || 'Nicht zugewiesen'}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="card-actions" style="margin-top: auto; display: flex; align-items: center; gap: 12px; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.06);">
                                    <button class="btn" style="flex: 1; min-height: 48px; border-radius: 14px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); color: #60a5fa; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: all 0.2s; font-family: 'Inter', sans-serif;" onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'" onclick="window.openServiceActionsModal(event, ${machine.id})">
                                        Berichte & Protokolle
                                    </button>
                                    <button class="btn-icon-soft delete" onclick="deleteMachine(${machine.id})" title="Maschine löschen" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.1); color: #ef4444; border-radius: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(239, 68, 68, 0.15)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.05)'">
                                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M3 6h18"></path>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `;
                            categoryContent.appendChild(card);
                        });

                        // Append category content to section
                        categorySection.appendChild(categoryHeader);
                        categorySection.appendChild(categoryContent);
                        container.appendChild(categorySection);
                    });

                    // Add "New Machine" Card (outside category loop)
                    const addCard = document.createElement('div');
                    addCard.className = 'card';
                    addCard.style.cssText = 'font-family: \'Inter\', sans-serif; border: 2px dashed rgba(255,255,255,0.1); background: rgba(255,255,255,0.01); justify-content: center; align-items: center; cursor: pointer; min-height: 500px; display: flex; flex-direction: column; border-radius: 20px; transition: all 0.3s ease; grid-column: 1 / -1;';
                    addCard.onmouseover = () => { addCard.style.borderColor = 'rgba(59, 130, 246, 0.3)'; addCard.style.background = 'rgba(59, 130, 246, 0.03)'; };
                    addCard.onmouseout = () => { addCard.style.borderColor = 'rgba(255,255,255,0.1)'; addCard.style.background = 'rgba(255,255,255,0.01)'; };
                    addCard.onclick = () => openAddMachineModal();
                    addCard.innerHTML = `
                        <div style="color: #666; text-align: center; padding: 2rem; display: flex; flex-direction: column; align-items: center;">
                            <div style="width: 64px; height: 64px; border-radius: 50%; background: rgba(59, 130, 246, 0.1); display: flex; align-items: center; justify-content: center; margin-bottom: 1.25rem; color: #3b82f6;">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </div>
                            <p style="margin: 0; font-weight: 800; color: #aaa; font-size: 1.1rem;">Neue Maschine</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #666; max-width: 150px; line-height: 1.4; font-weight: 600;">Legen Sie ein neues Gerät im System an.</p>
                        </div>
                    `;
                    container.appendChild(addCard);
                }

                function getStatusColor(status) {
                    if (status === 'Betriebsbereit') return 'var(--color-primary-green)';
                    if (status === 'Wartung') return '#FFA000'; // Orange
                    if (status === 'Defekt') return '#D32F2F'; // Red
                    return '#333';
                }

                function formatDate(dateStr) {
                    if (!dateStr) return 'Kein Termin';
                    return new Date(dateStr).toLocaleDateString('de-DE');
                }

                // Helper for Creating Machine
                window.createMachine = async function () {
                    if (!supabaseClient) { alert('Datenbank nicht verbunden'); return; }

                    const name = prompt('Name der Maschine:');
                    if (!name) return;

                    // Category Selection (simple prompt for now, could be improved)
                    // In a real app we'd use a modal with dropdown
                    let catId = null;
                    if (categoryList.length > 0) {
                        // Simple way: show list and ask for ID (terrible UX but MVP step 1)
                        // Better: just pick first or ask for name match?
                        // Let's iterate categories and build a prompt string
                        const catString = categoryList.map(c => `${c.id}: ${c.name}`).join('\n');
                        const idInput = prompt(`Wähle eine Kategorie-ID:\n${catString}`);
                        catId = parseInt(idInput);
                        if (isNaN(catId)) catId = null;
                    }

                    const status = 'Betriebsbereit'; // Default

                    const { error } = await supabaseClient
                        .from('machines')
                        .insert([{ name: name, category_id: catId, status: status }]);

                    if (error) {
                        alert('Fehler: ' + error.message);
                    } else {
                        fetchMachines();
                    }
                };

                window.deleteMachine = async function (id) {
                    if (!supabaseClient) { alert('Datenbank nicht verbunden'); return; }
                    if (confirm('Maschine wirklich löschen?')) {
                        const { error } = await supabaseClient.from('machines').delete().eq('id', id);
                        if (error) alert('Fehler: ' + error.message);
                        else fetchMachines();
                    }
                }

                let currentEditingId = null;

                window.openEditStammdaten = function (id) {
                    const machines = window.machineList || [];
                    const machine = machines.find(m => m.id === id);
                    if (!machine) return;
                    updateLastViewed(id);
                    currentEditingId = id;
                    openAddMachineModal(machine);
                };

                window.openMachineDetails = window.openEditStammdaten; // Legacy shim


                // Group Color Persistence
                window.updateGroupColor = function (type, color) {
                    localStorage.setItem(`cat_group_color_${type}`, color);
                    applyGroupStyles(type, color);
                    // Re-render categories to apply the new accent color to items
                    renderCategoryList();
                };

                function applyGroupStyles(type, color) {
                    const iconWrapper = document.getElementById(`icon-group-${type}`);
                    if (iconWrapper) {
                        iconWrapper.style.color = color;
                    }
                    // Update the color input value to stay in sync
                    const input = document.getElementById(`color-${type}`);
                    if (input) input.value = color;
                }

                function loadGroupColors() {
                    ['machine', 'service', 'contact'].forEach(type => {
                        const saved = localStorage.getItem(`cat_group_color_${type}`);
                        if (saved) {
                            applyGroupStyles(type, saved);
                        } else {
                            // Defaults
                            const defaults = { machine: '#e67e22', service: '#2980b9', contact: '#9b59b6' };
                            applyGroupStyles(type, defaults[type]);
                        }
                    });
                }

                // Call on start
                loadGroupColors();


                // GLOBAL NAVIGATION HELPER (for Settings Cards and Back Buttons)
                // Map and Modal Logic
                let map = null;
                let marker = null;

                window.openAddMachineModal = async function (editData = null) {
                    try {
                        const modal = document.getElementById('add-machine-modal');
                        if (!modal) { alert('Fehler: Modal-Element nicht gefunden!'); return; }

                        const titleEl = modal.querySelector('h2');
                        const submitBtn = document.querySelector('button[onclick="submitNewMachine()"]');

                        if (editData) {
                            currentEditingId = editData.id;
                            if (titleEl) titleEl.textContent = 'Maschine bearbeiten';
                            if (submitBtn) submitBtn.textContent = 'Speichern';
                        } else {
                            currentEditingId = null;
                            if (titleEl) titleEl.textContent = 'Neue Maschine anlegen';
                            if (submitBtn) submitBtn.textContent = 'Maschine anlegen';
                        }

                        modal.classList.remove('hidden');
                        modal.style.display = 'flex';
                        requestAnimationFrame(() => {
                            modal.classList.add('show');
                        });

                        // Reset Files
                        machineFiles = [];
                        existingMachineFiles = editData ? (editData.files || []) : [];
                        machineMainImage = editData ? (editData.image_url || null) : null;
                        renderMachineFilePreviews();

                        // Reset fields or populate with editData
                        document.getElementById('machine-name').value = editData ? (editData.name || '') : '';
                        document.getElementById('machine-manufacturer').value = editData ? (editData.manufacturer || '') : '';
                        document.getElementById('machine-serial').value = editData ? (editData.serial || '') : '';
                        document.getElementById('machine-year').value = editData ? (editData.year || '') : '';
                        document.getElementById('machine-owner').value = editData ? (editData.company || '') : '';
                        document.getElementById('machine-address-input').value = editData ? (editData.operator_address || '') : '';
                        document.getElementById('machine-location-input').value = editData ? (editData.location || '') : '';
                        document.getElementById('machine-last-maintenance').value = editData ? (editData.last_maintenance || '') : '';
                        document.getElementById('machine-next-maintenance').value = editData ? (editData.next_maintenance || '') : '';
                        document.getElementById('machine-image-url').value = editData ? (editData.image_url || '') : '';

                        // Handle Auto Badge in Modal
                        const badge = document.getElementById('maint-auto-badge');
                        if (badge) {
                            const isAuto = editData && Array.isArray(editData.files) && editData.files.some(f => f.type === 'meta' && f.key === 'is_next_maintenance_auto' && f.property === 'true');
                            if (isAuto) badge.classList.remove('hidden');
                            else badge.classList.add('hidden');
                        }

                        // Update Image Slot Preview
                        const imageSlot = document.getElementById('machine-image-slot');
                        if (imageSlot) {
                            if (editData && editData.image_url) {
                                imageSlot.innerHTML = `<img src="${editData.image_url}" alt="Maschinenbild" style="width: 100%; height: 100%; object-fit: cover;">`;
                            } else {
                                imageSlot.innerHTML = `
                                    <div class="placeholder-content-inner" style="display: flex; flex-direction: column; align-items: center; gap: 12px; pointer-events: none;">
                                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;">
                                            <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                                            <circle cx="12" cy="13" r="3"/>
                                        </svg>
                                        <span class="placeholder-text" style="font-size: 0.9rem; color: rgba(255,255,255,0.4); font-weight: 500;">Foto hinzufügen</span>
                                    </div>
                                `;
                            }
                        }

                        // Populate Files
                        if (editData) {
                            if (editData.files && Array.isArray(editData.files)) {
                                existingMachineFiles = [...editData.files];
                            } else if (editData.image_url) {
                                // Legacy support: if no files array but image_url exists
                                existingMachineFiles.push({
                                    name: 'Aktuelles Bild',
                                    type: 'image/jpeg',
                                    url: editData.image_url
                                });
                            }
                        }

                        // Render Previews
                        if (typeof renderMachineFilePreviews === 'function') {
                            renderMachineFilePreviews();
                        }

                        // Reset Contact Dropdown
                        const contactText = document.getElementById('contact-text');
                        const contactInput = document.getElementById('machine-contact-type');
                        const checkboxes = document.querySelectorAll('#contact-list input[type="checkbox"]');
                        if (contactText) contactText.textContent = 'Bitte wählen...';
                        if (contactInput) contactInput.value = '';
                        checkboxes.forEach(cb => cb.checked = false);

                        // Initialize Map if not already done
                        if (!map && typeof L !== 'undefined') {
                            setTimeout(() => {
                                try {
                                    map = L.map('machine-map').setView([51.1657, 10.4515], 6); // Center of Germany
                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                        attribution: '&copy; OpenStreetMap contributors'
                                    }).addTo(map);

                                    // Click to set pin
                                    map.on('click', function (e) {
                                        setMapPin(e.latlng.lat, e.latlng.lng);
                                    });
                                } catch (err) {
                                    console.error('Map init error:', err);
                                    document.getElementById('machine-map').innerHTML = '<p style="color:white; padding:10px;">Karte konnte nicht geladen werden.</p>';
                                }
                            }, 300); // Small delay for modal transition
                        }

                        // POPULATE Categories
                        const catList = document.getElementById('machine-category-list');
                        const catText = document.getElementById('machine-category-text');
                        const catInput = document.getElementById('machine-category');

                        const contactList = document.getElementById('contact-list');

                        if (typeof categoryList === 'undefined' || !Array.isArray(categoryList) || categoryList.length === 0) {
                            await fetchCategories();
                        }

                        // Populate Machine Categories
                        if (catList && catText && catInput) {
                            catList.innerHTML = '';
                            if (editData && editData.category_id) {
                                const selectedCat = categoryList.find(c => c.id === editData.category_id);
                                if (selectedCat) {
                                    catText.textContent = selectedCat.name;
                                    catText.style.color = 'white';
                                    catInput.value = selectedCat.id;
                                } else {
                                    catText.textContent = 'Bitte wählen...';
                                    catInput.value = '';
                                }
                            } else {
                                catText.textContent = 'Bitte wählen...';
                                catInput.value = '';
                            }

                            const cats = (typeof categoryList !== 'undefined' && Array.isArray(categoryList))
                                ? categoryList.filter(cat => cat.type === 'machine' && !['UVV', 'Wartung', 'DGUV'].includes(cat.name))
                                : [];

                            if (cats.length === 0) {
                                catList.innerHTML = '<li class="suggestion-item" style="color: #aaa;">Keine Kategorien gefunden</li>';
                            } else {
                                cats.forEach(cat => {
                                    const li = document.createElement('li');
                                    li.className = 'suggestion-item';
                                    li.textContent = cat.name;
                                    li.onclick = (e) => {
                                        e.stopPropagation();
                                        selectCategory(cat.id, cat.name);
                                    };
                                    catList.appendChild(li);
                                });
                            }
                        }

                        // Populate Contact Types
                        // Populate Contact Types
                        if (contactList) {
                            contactList.innerHTML = '';
                            const contactCats = (typeof categoryList !== 'undefined' && Array.isArray(categoryList))
                                ? categoryList.filter(cat => cat.type === 'contact')
                                : [];

                            if (contactCats.length === 0) {
                                contactList.innerHTML = '<li class="suggestion-item" style="color: #aaa;">Keine Kontaktarten gefunden</li>';
                            } else {
                                contactCats.forEach(cat => {
                                    const li = document.createElement('li');
                                    li.className = 'suggestion-item';
                                    li.onclick = function () { toggleContactSelection(this, cat.name); };

                                    // Custom Checkmark HTML
                                    li.innerHTML = `
                                        <div class="checkmark-icon">
                                            <svg class="checkmark-svg" viewBox="0 0 24 24">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </div>
                                        <span class="contact-name" style="margin-left: 10px;">${cat.name}</span>
                                        <input type="checkbox" style="display: none;" value="${cat.name}">
                                    `;
                                    contactList.appendChild(li);
                                });
                            }
                        }

                        // Updated Toggle Function (make sure this is global/accessible)
                        window.toggleContactSelection = function (li, value) {
                            const checkbox = li.querySelector('input[type="checkbox"]');
                            checkbox.checked = !checkbox.checked;

                            // Visual Toggle
                            if (checkbox.checked) {
                                li.classList.add('selected');
                            } else {
                                li.classList.remove('selected');
                            }

                            updateContactDisplay();
                        };

                    } catch (e) {
                        alert('Ein Fehler ist aufgetreten: ' + e.message);
                        console.error(e);
                    }
                };

                // Custom Dropdown Logic
                window.toggleCategoryDropdown = function (e) {
                    if (e) e.stopPropagation();
                    const dropdown = document.getElementById('machine-category-dropdown');
                    if (dropdown) dropdown.classList.toggle('show');
                };

                window.selectCategory = function (id, name) {
                    document.getElementById('machine-category').value = id;
                    document.getElementById('machine-category-text').textContent = name;
                    document.getElementById('machine-category-text').style.color = 'white';
                    const dropdown = document.getElementById('machine-category-dropdown');
                    if (dropdown) dropdown.classList.remove('show');

                    // Auto-calculate next maintenance date if category changes
                    if (typeof calculateNextMaintenanceDate === 'function') calculateNextMaintenanceDate();
                };

                window.toggleContactDropdown = function (e) {
                    if (e) e.stopPropagation();
                    const dropdown = document.getElementById('contact-dropdown');
                    if (dropdown) dropdown.classList.toggle('show');
                };

                // window.toggleContactSelection is now defined above in openAddMachineModal 
                // to capture the closure scope if needed, or just globally.
                // We moved it to be global but defined inside the modal openeing? 
                // Actually, defining it inside openAddMachineModal repeatedly is bad practice.
                // Let's keep the one I added and remove this old one.

                function updateContactDisplay() {
                    const checkboxes = document.querySelectorAll('#contact-list input[type="checkbox"]:checked');
                    // Use .value instead of textContent for robustness
                    const selectedValues = Array.from(checkboxes).map(cb => cb.value);

                    const textEl = document.getElementById('contact-text');
                    const inputEl = document.getElementById('machine-contact-type');

                    if (selectedValues.length === 0) {
                        textEl.textContent = 'Bitte wählen...';
                        textEl.style.color = '';
                        inputEl.value = '';
                    } else {
                        textEl.textContent = selectedValues.join(', ');
                        textEl.style.color = 'white';
                        inputEl.value = JSON.stringify(selectedValues);
                    }
                }

                // Close dropdowns when clicking outside
                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    // Category Dropdown
                    const catDropdown = document.getElementById('machine-category-dropdown');
                    const catTrigger = document.getElementById('machine-category-trigger');
                    if (catDropdown && catDropdown.classList.contains('show') && !catTrigger.contains(e.target)) {
                        catDropdown.classList.remove('show');
                    }

                    // Contact Dropdown
                    const contactDropdown = document.getElementById('contact-dropdown');
                    const contactTrigger = document.getElementById('contact-trigger');
                    // Prevent closing if clicking inside the dropdown list (to allow multiple selections)
                    if (contactDropdown && contactDropdown.classList.contains('show') &&
                        !contactTrigger.contains(e.target) && !contactDropdown.contains(e.target)) {
                        contactDropdown.classList.remove('show');
                    }
                });

                window.closeAddMachineModal = function () {
                    const modal = document.getElementById('add-machine-modal');
                    if (modal) {
                        modal.classList.remove('show');
                        setTimeout(() => {
                            modal.classList.add('hidden');
                            modal.style.display = 'none';
                        }, 300);
                    }
                };

                // Override the old createMachine to open modal
                window.createMachine = function () {
                    openAddMachineModal();
                };

                function setMapPin(lat, lng) {
                    if (marker) map.removeLayer(marker);
                    marker = L.marker([lat, lng]).addTo(map);
                    document.getElementById('machine-lat').value = lat;
                    document.getElementById('machine-lng').value = lng;
                }

                // Open Google Maps
                window.openGoogleMaps = function () {
                    const query = document.getElementById('machine-address-input').value;
                    if (!query) { alert('Bitte erst eine Adresse eingeben.'); return; }
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
                };

                let searchTimeout;
                window.debounceSearchAddress = function () {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(window.searchAddress, 500);
                };

                // Address Search (Nominatim)
                window.searchAddress = async function () {
                    const query = document.getElementById('machine-address-input').value;
                    if (!query || query.length < 3) return; // Min length

                    const suggestionsBox = document.getElementById('address-suggestions');
                    suggestionsBox.style.display = 'block';
                    suggestionsBox.innerHTML = '<div class="suggestion-item">Lade Vorschläge...</div>';

                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                        // ... rest of search logic remains same ...
                        const data = await response.json();

                        suggestionsBox.innerHTML = '';
                        if (data.length === 0) {
                            suggestionsBox.innerHTML = '<div class="suggestion-item">Keine Ergebnisse</div>';
                            return;
                        }

                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.innerText = item.display_name;
                            div.onclick = () => {
                                selectAddress(item);
                            };
                            suggestionsBox.appendChild(div);
                        });
                    } catch (e) {
                        suggestionsBox.innerHTML = '<div class="suggestion-item">Fehler bei der Suche</div>';
                    }
                };

                function selectAddress(item) {
                    document.getElementById('machine-address-input').value = item.display_name;
                    document.getElementById('address-suggestions').style.display = 'none';

                    const lat = parseFloat(item.lat);
                    const lon = parseFloat(item.lon);

                    map.setView([lat, lon], 16);
                    setMapPin(lat, lon);
                }

                window.calculateNextMaintenanceDate = function () {
                    const lastDateVal = document.getElementById('machine-last-maintenance').value;
                    const catId = document.getElementById('machine-category').value;

                    if (!lastDateVal || !catId) return;

                    const cat = (window.categoryList || []).find(c => c.id == catId);
                    if (!cat) return;

                    const months = cat.default_maintenance_interval_months || 12;
                    const lastDate = new Date(lastDateVal);
                    if (isNaN(lastDate.getTime())) return;

                    const nextDate = new Date(lastDate);
                    nextDate.setMonth(nextDate.getMonth() + months);

                    // Format to YYYY-MM-DD
                    const yyyy = nextDate.getFullYear();
                    const mm = String(nextDate.getMonth() + 1).padStart(2, '0');
                    const dd = String(nextDate.getDate()).padStart(2, '0');

                    document.getElementById('machine-next-maintenance').value = `${yyyy}-${mm}-${dd}`;

                    // Show "Auto" badge
                    const badge = document.getElementById('maint-auto-badge');
                    if (badge) badge.classList.remove('hidden');
                };

                // Submit Logic
                // Submit Logic
                window.submitNewMachine = async function () {
                    console.log('--- Start: submitNewMachine ---');
                    const submitBtn = document.querySelector('button[onclick="submitNewMachine()"]');
                    const originalBtnText = submitBtn ? submitBtn.textContent : 'Speichern';
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Speichere...';
                    }

                    try {
                        if (!supabaseClient) throw new Error('Supabase ist nicht initialisiert!');

                        // 1. Gather Data
                        const categoryId = document.getElementById('machine-category').value;
                        const manufacturer = document.getElementById('machine-manufacturer').value;
                        const name = document.getElementById('machine-name').value;
                        const serial = document.getElementById('machine-serial').value;
                        const year = document.getElementById('machine-year').value;
                        const contactType = document.getElementById('machine-contact-type').value; // JSON string
                        const lastMaintenance = document.getElementById('machine-last-maintenance').value;
                        const nextMaintenance = document.getElementById('machine-next-maintenance').value;
                        const owner = document.getElementById('machine-owner').value;
                        const operatorAddress = document.getElementById('machine-address-input').value;
                        const locationAddress = document.getElementById('machine-location-input').value;

                        // Basic Validation
                        if (!categoryId) {
                            throw new Error('Bitte eine Kategorie wählen.');
                        }
                        if (!name) {
                            throw new Error('Bitte eine Typbezeichnung angeben.');
                        }

                        // 2. Handle Files (Upload New & Combine with Existing)
                        const isAuto = !document.getElementById('maint-auto-badge').classList.contains('hidden');
                        let finalFiles = [...existingMachineFiles];

                        // Remove old meta if exists
                        finalFiles = finalFiles.filter(f => f.type !== 'meta' || f.key !== 'is_next_maintenance_auto');
                        if (isAuto) {
                            finalFiles.push({ type: 'meta', key: 'is_next_maintenance_auto', property: 'true' });
                        }

                        if (machineFiles.length > 0) {
                            const newUploaded = await uploadMachineFiles();
                            finalFiles = [...finalFiles, ...newUploaded];
                        }

                        // Determine main image_url
                        let mainImageUrl = machineMainImage;

                        // If machineMainImage is still a DataURL (newly added but not yet mapped),
                        // or if it's null but we have images, pick the first available image.
                        if (!mainImageUrl || mainImageUrl.startsWith('data:')) {
                            const firstImage = finalFiles.find(f => (f.type && f.type.startsWith('image/')) || (f.url && f.url.match(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i)));
                            if (firstImage) {
                                mainImageUrl = firstImage.url;
                            } else {
                                mainImageUrl = null;
                            }
                        }

                        // 3. Insert or Update Database
                        const machineData = {
                            name: name,
                            category_id: parseInt(categoryId),
                            manufacturer: manufacturer,
                            serial: serial,
                            year: year ? parseInt(year) : null,
                            contact_type: (contactType && contactType.trim() !== '') ? JSON.parse(contactType) : [],
                            last_maintenance: lastMaintenance || null,
                            next_maintenance: nextMaintenance || null,
                            company: owner,
                            operator_address: operatorAddress,
                            location: locationAddress,
                            image_url: mainImageUrl, // Main image
                            files: finalFiles,      // All files including docs
                            status: 'Betriebsbereit' // Default
                        };

                        console.log('Sending machine data to Supabase:', machineData);

                        let result;
                        if (typeof currentEditingId !== 'undefined' && currentEditingId) {
                            result = await supabaseClient
                                .from('machines')
                                .update(machineData)
                                .eq('id', currentEditingId);
                        } else {
                            result = await supabaseClient
                                .from('machines')
                                .insert([machineData]);
                        }

                        if (result.error) throw result.error;

                        // Success
                        alert(typeof currentEditingId !== 'undefined' && currentEditingId ? 'Maschine aktualisiert!' : 'Maschine erfolgreich angelegt!');
                        closeAddMachineModal();

                        if (typeof fetchMachines === 'function') {
                            fetchMachines();
                        } else {
                            location.reload();
                        }

                    } catch (err) {
                        console.error('CRITICAL ERROR in submitNewMachine:', err);
                        const errorMsg = err.message || err.error_description || JSON.stringify(err);
                        alert('Fehler beim Speichern: ' + errorMsg);
                    } finally {
                        submitBtn.textContent = originalBtnText;
                        submitBtn.disabled = false;
                    }
                };

                // Close suggestions on click outside
                document.addEventListener('click', function (e) {
                    if (!e.target.closest('.form-group')) {
                        document.getElementById('address-suggestions').style.display = 'none';
                    }
                });


                // File Upload Listeners (moved inside DOMContentLoaded for reliable element availability)
                const machineFileInput = document.getElementById('machine-image-upload');
                const machineImageSlot = document.getElementById('machine-image-slot');

                if (machineFileInput) {
                    machineFileInput.addEventListener('change', () => {
                        handleMachineFiles(machineFileInput.files);
                    });
                }

                const lastMaintInput = document.getElementById('machine-last-maintenance');
                if (lastMaintInput) {
                    lastMaintInput.addEventListener('change', () => {
                        window.calculateNextMaintenanceDate();
                    });
                }

                const nextMaintInput = document.getElementById('machine-next-maintenance');
                if (nextMaintInput) {
                    nextMaintInput.addEventListener('input', () => {
                        const badge = document.getElementById('maint-auto-badge');
                        if (badge) badge.classList.add('hidden');
                    });
                }

                if (machineImageSlot) {
                    machineImageSlot.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        machineImageSlot.classList.add('drag-over');
                    });
                    machineImageSlot.addEventListener('dragleave', () => {
                        machineImageSlot.classList.remove('drag-over');
                    });
                    machineImageSlot.addEventListener('drop', (e) => {
                        e.preventDefault();
                        machineImageSlot.classList.remove('drag-over');
                        handleMachineFiles(e.dataTransfer.files);
                    });
                }

                const dropzone = document.getElementById('service-file-dropzone');
                const serviceFileInput = document.getElementById('service-file-input');

                if (dropzone) {
                    dropzone.onclick = () => serviceFileInput.click();
                    dropzone.ondragover = (e) => { e.preventDefault(); dropzone.classList.add('drag-over'); };
                    dropzone.ondragleave = () => dropzone.classList.remove('drag-over');
                    dropzone.ondrop = (e) => {
                        e.preventDefault();
                        dropzone.classList.remove('drag-over');
                        handleServiceFiles(e.dataTransfer.files);
                    };
                }

                if (serviceFileInput) {
                    serviceFileInput.onchange = (e) => handleServiceFiles(e.target.files);
                }

            }); // End of DOMContentLoaded




            // Drag & Drop Logic state
            let machineFiles = [];
            let existingMachineFiles = [];
            let machineMainImage = null;

            function handleMachineFiles(files) {
                Array.from(files).forEach(file => {
                    machineFiles.push(file);
                });
                renderMachineFilePreviews();
            }

            function renderMachineFilePreviews() {
                const previewGrid = document.getElementById('machine-file-previews');
                const imageSlot = document.getElementById('machine-image-slot');
                if (previewGrid) previewGrid.innerHTML = '';

                // Sync with Slot (Show machineMainImage if set, otherwise first available image)
                if (imageSlot) {
                    let previewUrl = machineMainImage;

                    // If no explicit main image is set, try to find a fallback
                    if (!previewUrl) {
                        const firstExisting = existingMachineFiles.find(f => (f.type && f.type.startsWith('image/')) || (f.url && f.url.match(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i)));
                        const firstNew = machineFiles.find(f => (f.type && f.type.startsWith('image/')) || (f.name && f.name.match(/\.(jpg|jpeg|png|gif|webp)$/i)));

                        if (firstExisting) previewUrl = firstExisting.url;
                        else if (firstNew) {
                            try {
                                previewUrl = URL.createObjectURL(firstNew);
                            } catch (e) {
                                console.warn('Failed to create object URL for preview', e);
                            }
                        }
                    }

                    if (previewUrl) {
                        imageSlot.innerHTML = `<img src="${previewUrl}" alt="Maschinenbild" style="width: 100%; height: 100%; object-fit: contain; background: rgba(0,0,0,0.2); border-radius: 12px;">`;
                    } else {
                        imageSlot.innerHTML = `
                        <div class="placeholder-content-inner" style="display: flex; flex-direction: column; align-items: center; gap: 12px; pointer-events: none;">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;">
                                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" />
                                <circle cx="12" cy="13" r="3" />
                            </svg>
                            <span class="placeholder-text" style="font-size: 0.9rem; color: rgba(255,255,255,0.4); font-weight: 500;">Foto hinzufügen</span>
                        </div>
                    `;
                    }
                }

                if (!previewGrid) return;

                // 1. Render Existing Files
                existingMachineFiles.forEach((file, index) => {
                    renderMachineFileItem(file, index, true, previewGrid);
                });

                // 2. Render New Files
                machineFiles.forEach((file, index) => {
                    renderMachineFileItem(file, index, false, previewGrid);
                });
            }

            function renderMachineFileItem(file, index, isExisting, container) {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                item.style.position = 'relative';

                // Normalise data
                const isLegacy = typeof file === 'string'; // Should not happen for new 'files' column but maybe for 'image_url'
                // if we merge?
                // Actually machine 'files' column should be array of objects.

                const name = isExisting ? (file.name || 'Datei') : file.name;
                const type = isExisting ? (file.type || '?') : file.type;
                const url = isExisting ? file.url : null;

                const isImg = (type && type.startsWith('image/')) || (name && name.match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/i)) || (url && url.match(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i));

                if (isImg) {
                    const isMain = isExisting ? (url === machineMainImage) : false; // For new files, it's slightly trickier, handled in setMachineMainImage
                    if (isMain) item.classList.add('is-main');
                }

                if (isExisting) {
                    if (isImg) {
                        item.innerHTML = `
                        <img src="${url}">
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; font-size: 0.6rem; padding: 2px 4px;">${name}</div>
                            <button class="set-main-btn" onclick="setMachineMainImage(${index}, true)" title="Als Titelbild festlegen">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="${item.classList.contains('is-main') ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                            </button>
                            <button class="remove-btn" onclick="removeMachineFile(${index}, true)">&times;</button>
                    `;
                    } else {
                        // PDF/Doc
                        let typeLabel = 'DOK';
                        if (type === 'application/pdf' || (url && url.endsWith('.pdf'))) typeLabel = 'PDF';

                        item.innerHTML = `
                        <div style="padding: 0.5rem; text-align: center; color: white; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <span style="font-weight: 900; font-size: 0.8rem; opacity: 0.5;">${typeLabel}</span>
                                <span style="font-size: 0.7rem; word-break: break-all; overflow: hidden; max-height: 3em;">${name}</span>
                            </div>
                        <button class="remove-btn" onclick="removeMachineFile(${index}, true)">&times;</button>
                    `;
                    }
                } else {
                    // New File
                    if (isImg) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const blobUrl = e.target.result;
                            const isMain = (machineMainImage === blobUrl);
                            if (isMain) item.classList.add('is-main');

                            item.innerHTML = `
                        <img src="${blobUrl}">
                                <button class="set-main-btn" onclick="setMachineMainImage(${index}, false)" title="Als Titelbild festlegen">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="${isMain ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                </button>
                                <button class="remove-btn" onclick="removeMachineFile(${index}, false)">&times;</button>
                    `;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        let typeLabel = 'DOK';
                        if (file.type === 'application/pdf') typeLabel = 'PDF';
                        item.innerHTML = `
                        <div style="padding: 0.5rem; text-align: center; color: white; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <span style="font-weight: 900; font-size: 0.8rem; opacity: 0.5;">${typeLabel}</span>
                                <span style="font-size: 0.7rem; word-break: break-all; overflow: hidden; max-height: 3em;">${file.name}</span>
                            </div>
                        <button class="remove-btn" onclick="removeMachineFile(${index}, false)">&times;</button>
                    `;
                    }
                }
                container.appendChild(item);
            }

            window.setMachineMainImage = function (index, isExisting) {
                if (isExisting) {
                    machineMainImage = existingMachineFiles[index].url;
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        machineMainImage = e.target.result;
                        renderMachineFilePreviews();
                    };
                    reader.readAsDataURL(machineFiles[index]);
                    return; // Preview update will happen in onload
                }
                renderMachineFilePreviews();
            };

            window.removeMachineFile = function (index, isExisting) {
                let removedUrl = null;
                if (isExisting) {
                    removedUrl = existingMachineFiles[index].url;
                    existingMachineFiles.splice(index, 1);
                } else {
                    // For blob URLs, we'd need to track them or just check the reader result again
                    // simplifying: if machineMainImage matches the preview of this file
                    machineFiles.splice(index, 1);
                }

                // If we removed the main image, reset it
                if (machineMainImage === removedUrl) {
                    machineMainImage = null;
                }

                renderMachineFilePreviews();
            };

            // Replaces uploadImageToSupabase with uploadMachineFiles
            async function uploadMachineFiles() {
                const uploadedFiles = [];

                console.log(`Starting upload for ${machineFiles.length} files to meetra - storage...`);

                // Upload new files
                for (const file of machineFiles) {
                    const cleanName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, '_');
                    const fileName = `Maschinen / ${Date.now()} -${cleanName} `;
                    console.log(`Uploading file: ${file.name} to path: ${fileName} `);

                    const { data, error } = await supabaseClient.storage.from('meetra-storage').upload(fileName, file);

                    if (error) {
                        console.error('Upload error detail:', error);
                        throw error;
                    }

                    const { data: pubData } = supabaseClient.storage.from('meetra-storage').getPublicUrl(fileName);
                    uploadedFiles.push({
                        name: file.name,
                        type: file.type,
                        url: pubData.publicUrl
                    });
                }

                return uploadedFiles;
            }

            // ==========================================
            // SERVICEEINSÄTZE LOGIC
            // ==========================================
            window.openReportTypeModal = function () {
                const modal = document.getElementById('report-type-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    requestAnimationFrame(() => {
                        modal.classList.add('show');
                    });
                }
            };

            window.closeReportTypeModal = function () {
                const modal = document.getElementById('report-type-modal');
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        modal.style.display = 'none';
                    }, 300);
                }
            };


            let currentEditingServiceId = null;



            window.closeServiceberichtModal = function () {
                const modal = document.getElementById('servicebericht-modal');
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        modal.style.display = 'none';
                    }, 300);
                }
            };

            // Machine Selection Logic
            function renderServiceMachineList(filter = '') {
                console.log('Rendering Service Machine List. Filter:', filter);
                const list = document.getElementById('service-machine-list');
                if (!list) { console.error('Service machine list element not found'); return; }

                // Ensure data availability
                const machines = window.machineList || machineList || [];
                const categories = window.categoryList || categoryList || [];


                const filtered = machines.filter(m => {
                    // Resolve Category Name
                    const cat = categories.find(c => c.id === m.category_id);
                    const catName = cat ? cat.name : '';

                    const fullSearchString = `${m.manufacturer || ''} ${m.name || ''} ${m.serial || ''} ${m.year || ''}
        ${catName} `.toLowerCase();
                    return fullSearchString.includes(filter.toLowerCase());
                });

                if (filtered.length === 0) {
                    list.innerHTML = `<div class="empty-hint"
                    style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.3);">Keine Maschinen gefunden.</div>`;
                    return;
                }

                list.innerHTML = filtered.map(m => {
                    const cat = categories.find(c => c.id === m.category_id);
                    const catName = cat ? cat.name : 'Unkategorisiert';

                    // Build full title string: "Manufacturer Name #Serial (Year)"
                    const titleParts = [
                        m.manufacturer,
                        m.name,
                        m.serial ? `#${m.serial} ` : '',
                        m.year ? `(${m.year})` : ''
                    ].filter(Boolean).join(' ');

                    return `
                        <div class="premium-item"
                    onclick="selectServiceMachine(${m.id}, '${m.manufacturer}', '${m.name}', '${m.serial || ''}', '${m.image_url || ''}', '${catName}', '${m.year || ''}')"
                    id="machine-item-${m.id}" style="font-family: 'Inter', sans-serif;">
            <div class="premium-item-img">
                ${m.image_url ? `<img src="${m.image_url}">` : `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>`}
            </div >
                        <div class="premium-item-info">
                            <strong style="color: white; font-weight: 600;">${titleParts}</strong>
                            <small style="display: flex; gap: 8px; align-items: center; color: rgba(255,255,255,0.6);">
                                <span style="color: var(--color-primary-green);">${catName}</span>
                            </small>
                        </div>
        </div >
                        `;
                }).join('');
            }

            window.filterServiceMachines = function () {
                const search = document.getElementById('service-machine-search').value;
                renderServiceMachineList(search);
            };

            window.selectServiceMachine = function (id, manufacturer, name, serial, imageUrl, categoryName, year) {
                document.getElementById('selected-machine-id').value = id;
                document.querySelectorAll('#service-machine-list .premium-item').forEach(el => el.classList.remove('selected'));
                const selectedItem = document.getElementById(`machine-item-${id}`);
                if (selectedItem) selectedItem.classList.add('selected');

                // Update Preview
                const previewContainer = document.getElementById('selected-machine-preview');
                const previewImg = document.getElementById('preview-image');
                const previewName = document.getElementById('preview-name');
                const previewSerial = document.getElementById('preview-serial');

                if (previewContainer) {
                    previewContainer.classList.remove('hidden');
                    previewContainer.style.display = 'block'; // Ensure visibility

                    // Row 1: Manufacturer Name #Serial (Year)
                    const fullTitle = `${manufacturer} ${name}${serial ? ` #${serial}` : ''}${year ? ` (${year})` : ''}`;

                    previewName.innerHTML = `${fullTitle} <br> <span
                        style="font-size: 0.8em; color: var(--color-primary-green); font-weight: normal; margin-top: 4px; display: block;">${categoryName ||
                        ''}</span>`;
                    previewSerial.textContent = serial ? `S/N: ${serial}` : '';

                    if (imageUrl && imageUrl !== 'undefined' && imageUrl !== 'null') {
                        previewImg.innerHTML = `<img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    } else {
                        previewImg.innerHTML = `<div
            style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"><svg
                width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                </path>
            </svg></div>`;
                    }
                }
            };

            // Technician Selection Logic
            let selectedTechs = [];
            function renderServiceTechnicianList() {
                const grid = document.getElementById('technician-selection-grid');
                if (!grid) return;

                if (!grid) return;

                const users = window.userList || [];
                grid.innerHTML = users.map(u => `
                        <div class="tech-pill ${selectedTechs.includes(u.id) ? 'selected' : ''}" onclick="toggleTechnician(${u.id})">
                            <div class="avatar" style="background: ${u.color || '#666'}">
                                ${u.initials || u.name.substring(0, 2).toUpperCase()}
                            </div>
                            <span>${u.name}</span>
                        </div>
                        `).join('');
            }

            window.toggleTechnician = function (id) {
                const idx = selectedTechs.indexOf(id);
                if (idx > -1) {
                    selectedTechs.splice(idx, 1);
                } else {
                    selectedTechs.push(id);
                }
                document.getElementById('selected-technician-ids').value = JSON.stringify(selectedTechs);
                renderServiceTechnicianList();
            };

            let serviceFiles = []; // New files to upload
            let existingServiceFiles = []; // Files already in DB

            function handleServiceFiles(files) {
                Array.from(files).forEach(file => {
                    serviceFiles.push(file);
                });
                renderServiceFilePreviews();
            }

            function renderServiceFilePreviews() {
                const previewGrid = document.getElementById('service-file-previews');
                if (!previewGrid) return;
                previewGrid.innerHTML = '';

                // 1. Render Existing Files
                existingServiceFiles.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'file-preview-item';
                    item.style.position = 'relative'; // Ensure relative positioning for overlays

                    // Handle legacy string URLs vs new Object structure
                    const isLegacy = typeof file === 'string';
                    const url = isLegacy ? file : file.url;
                    const name = isLegacy ? 'Datei' : file.name;
                    const type = isLegacy ? '?' : file.type;

                    const isImg = (type && type.startsWith('image/')) || (url && url.match(/\.(jpg|jpeg|png|gif|webp)$/i));

                    if (isImg) {
                        item.innerHTML = `<img src="${url}">
        <div
            style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; font-size: 0.6rem; padding: 2px 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            ${name}
        </div>
        <button class="remove-btn" onclick="removeExistingServiceFile(${index})">&times;</button>`;
                    } else {
                        // PDF/Doc
                        let typeLabel = 'DOK';
                        if (type === 'application/pdf' || (url && url.endsWith('.pdf'))) typeLabel = 'PDF';

                        item.innerHTML = `<div
                            style="padding: 0.5rem; text-align: center; color: white; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <span style="font-weight: 900; font-size: 0.8rem; opacity: 0.5;">${typeLabel}</span>
                            <span
                                style="font-size: 0.7rem; word-break: break-all; overflow: hidden; max-height: 3em; line-height: 1.2;">${name}</span>
                        </div>
                        <button class="remove-btn" onclick="removeExistingServiceFile(${index})">&times;</button>`;
                    }
                    previewGrid.appendChild(item);
                });

                // 2. Render New Files
                serviceFiles.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'file-preview-item';
                    item.style.position = 'relative';

                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            item.innerHTML = `<img src="${e.target.result}">
        <div
            style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; font-size: 0.6rem; padding: 2px 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            ${file.name}
        </div>
        <button class="remove-btn" onclick="removeServiceFile(${index})">&times;</button>`;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        let typeLabel = 'DOK';
                        if (file.type === 'application/pdf') typeLabel = 'PDF';

                        item.innerHTML = `<div
                            style="padding: 0.5rem; text-align: center; color: white; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <span style="font-weight: 900; font-size: 0.8rem; opacity: 0.5;">${typeLabel}</span>
                            <span
                                style="font-size: 0.7rem; word-break: break-all; overflow: hidden; max-height: 3em; line-height: 1.2;">${file.name}</span>
                        </div>
                        <button class="remove-btn" onclick="removeServiceFile(${index})">&times;</button>`;
                    }
                    previewGrid.appendChild(item);
                });
            }

            window.removeServiceFile = function (index) {
                serviceFiles.splice(index, 1);
                renderServiceFilePreviews();
            };

            window.removeExistingServiceFile = function (index) {
                existingServiceFiles.splice(index, 1);
                renderServiceFilePreviews();
            };

            // Submit Logic
            window.submitServicebericht = async function () {
                const submitBtn = document.querySelector('button[onclick="submitServicebericht()"]');
                const originalText = submitBtn ? submitBtn.textContent : 'Speichern';

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Speichere...';
                }

                console.log('--- Start: submitServicebericht ---');

                try {
                    if (!supabaseClient) throw new Error('Supabase client ist nicht initialisiert!');

                    const machineId = document.getElementById('selected-machine-id').value;
                    const startDate = document.getElementById('service-date-start').value;
                    const description = document.getElementById('service-description').value;

                    if (!machineId || !startDate || !description) {
                        alert('Bitte Maschine, Datum und Beschreibung ausfüllen.');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                        return;
                    }

                    console.log('Preparing files for Servicebericht...');

                    // 1. Prepare Final Files Array
                    const finalFiles = [...existingServiceFiles];

                    // 2. Upload New Files
                    for (const file of serviceFiles) {
                        const cleanName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, '_');
                        const fileName = `Servicebericht/${Date.now()}-service-${cleanName}`;
                        console.log('Uploading service file:', file.name, 'as', fileName);

                        const { data: uploadData, error: uploadError } = await supabaseClient.storage.from('meetra-storage').upload(fileName, file);

                        if (uploadError) {
                            console.error('Upload error detail (Service):', uploadError);
                            throw uploadError;
                        }

                        const { data: pubData } = supabaseClient.storage.from('meetra-storage').getPublicUrl(fileName);

                        finalFiles.push({
                            name: file.name,
                            type: file.type,
                            url: pubData.publicUrl
                        });
                    }

                    // 3. Save to database
                    const reportTitle = document.getElementById('service-report-title')?.value || 'Servicebericht';
                    const reportData = {
                        machine_id: parseInt(machineId),
                        title: reportTitle,
                        date: startDate,
                        hours: 0,
                        technicians: (typeof selectedTechs !== 'undefined') ? selectedTechs : [],
                        files: finalFiles,
                        description: description
                    };

                    console.log('Sending Servicebericht data to Supabase:', reportData);

                    let dbError;
                    if (typeof currentEditingServiceId !== 'undefined' && currentEditingServiceId) {
                        const { error: updateError } = await supabaseClient
                            .from('service_entries')
                            .update(reportData)
                            .eq('id', currentEditingServiceId);
                        dbError = updateError;
                    } else {
                        const { error: insertError } = await supabaseClient
                            .from('service_entries')
                            .insert([reportData]);
                        dbError = insertError;
                    }

                    if (dbError) {
                        console.error('Supabase DB Error (Servicebericht):', dbError);
                        throw dbError;
                    }

                    // --- Maintenance Logic Integration ---
                    const targetMachineId = reportData.machine_id;
                    const serviceDate = reportData.date;
                    const overrideDate = document.getElementById('service-next-maintenance-override')?.value;

                    // 1. Get machine and category info
                    const machineRef = machineList.find(m => m.id === targetMachineId);
                    if (machineRef) {
                        const categoryRef = categoryList.find(c => c.id === machineRef.category_id);

                        let nextMaintDate;
                        if (overrideDate) {
                            nextMaintDate = new Date(overrideDate).toISOString();
                        } else {
                            // Calculate based on interval
                            const interval = machineRef.maintenance_interval_months || (categoryRef ? categoryRef.default_maintenance_interval_months : 12) || 12;
                            const calcDate = new Date(serviceDate);
                            calcDate.setMonth(calcDate.getMonth() + parseInt(interval));
                            nextMaintDate = calcDate.toISOString();
                        }

                        // 2. Update Machine Table
                        console.log('Updating machine maintenance dates:', { last: serviceDate, next: nextMaintDate });

                        // Handle Auto Badge in metadata
                        let updatedFiles = machineRef.files ? [...machineRef.files] : [];
                        updatedFiles = updatedFiles.filter(f => f.type !== 'meta' || f.key !== 'is_next_maintenance_auto');
                        if (!overrideDate) {
                            updatedFiles.push({ type: 'meta', key: 'is_next_maintenance_auto', property: 'true' });
                        }

                        const { error: machineUpdateError } = await supabaseClient
                            .from('machines')
                            .update({
                                last_maintenance: serviceDate,
                                next_maintenance: nextMaintDate,
                                files: updatedFiles
                            })
                            .eq('id', targetMachineId);

                        if (machineUpdateError) {
                            console.error('Error updating machine maintenance dates:', machineUpdateError);
                        }

                        // 3. (Optional) Create a maintenance event for the calendar
                        // We'll implement the calendar sync later or via a trigger
                    }

                    alert('Servicebericht wurde erfolgreich gespeichert!');
                    closeServiceberichtModal();
                    if (typeof fetchServiceEntries === 'function') fetchServiceEntries();
                    if (typeof fetchMachines === 'function') fetchMachines(); // Refresh machine cards

                } catch (err) {
                    console.error('CRITICAL ERROR saving service report:', err);
                    alert('Fehler beim Speichern: ' + (err.message || JSON.stringify(err)));
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }
            };

            window.openEditServicebericht = function (id) {
                const entry = allServiceEntries.find(e => e.id === id);
                if (!entry) return;
                openServiceberichtModal(entry);
            };

            window.deleteServiceEntry = async function (id) {
                if (confirm('Möchten Sie diesen Servicebericht wirklich löschen?')) {
                    try {
                        console.log('Deleting service entry:', id);
                        const { error } = await supabaseClient
                            .from('service_entries')
                            .delete()
                            .eq('id', id);

                        if (error) {
                            console.error('Supabase Error (deleteServiceEntry):', error);
                            throw error;
                        }
                        console.log('Service entry deleted successfully');
                        fetchServiceEntries();
                    } catch (err) {
                        alert('Fehler beim Löschen: ' + (err.message || JSON.stringify(err)));
                    }
                }
            };

            // ==========================================
            // NEW SERVICE INTERACTION LOGIC
            // ==========================================
            let currentSelectedMachineForService = null;
            let allServiceEntries = [];

            window.openServiceActionsModal = function (event, machineId) {
                if (event) event.stopPropagation();
                currentSelectedMachineForService = machineId;
                const modal = document.getElementById('service-action-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    requestAnimationFrame(() => {
                        modal.classList.add('show');

                        // Initially collapse everything
                        const anlegenContent = document.getElementById('report-options-anlegen');
                        const ansehenContent = document.getElementById('report-history-ansehen');
                        const anlegenIcon = document.getElementById('report-options-anlegen-icon');
                        const ansehenIcon = document.getElementById('report-history-ansehen-icon');

                        if (anlegenContent) {
                            anlegenContent.style.maxHeight = '0px';
                            anlegenContent.style.opacity = '0';
                            if (anlegenIcon) anlegenIcon.style.transform = 'rotate(-90deg)';
                        }
                        if (ansehenContent) {
                            ansehenContent.style.maxHeight = '0px';
                            ansehenContent.style.opacity = '0';
                            if (ansehenIcon) ansehenIcon.style.transform = 'rotate(-90deg)';
                        }
                    });
                }
            };

            window.closeServiceActionModal = function () {
                const modal = document.getElementById('service-action-modal');
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        modal.style.display = 'none';
                    }, 300);
                }
            };

            window.showServiceReportsForCurrentMachine = function (typeTitle) {
                closeServiceActionModal();
                if (!currentSelectedMachineForService) return;

                const machines = window.machineList || [];
                const machine = machines.find(m => m.id === currentSelectedMachineForService);
                if (!machine) return;

                // 1. Switch to Service View
                switchView('service');

                // 2. Pre-fill Search
                const searchInput = document.getElementById('service-search-input');
                if (searchInput) {
                    // Create a search string: Manufacturer Name Serial
                    const searchStr = [
                        machine.manufacturer,
                        machine.name,
                        machine.serial
                    ].filter(Boolean).join(' ');
                    searchInput.value = searchStr;
                }

                // 3. Fetch and Render (Filtered)
                fetchServiceEntries();
            };

            window.startReportCreation = function (type) {
                closeServiceActionModal();

                // Map internal type to readable title
                const titles = {
                    'servicebericht': 'Servicebericht',
                    'eingangsprotokoll': 'Eingangsprotokoll',
                    'abnahmeprotokoll': 'Abnahmeprotokoll'
                };

                const title = titles[type] || 'Servicebericht';

                // Handle new Protocols if applicable
                if (type === 'eingangsprotokoll' && typeof window.openIntakeProtocol === 'function') {
                    window.openIntakeProtocol(currentSelectedMachineForService);
                    return;
                }
                if (type === 'abnahmeprotokoll' && typeof window.openAcceptanceProtocol === 'function') {
                    window.openAcceptanceProtocol(currentSelectedMachineForService);
                    return;
                }

                // fallback to default service report modal
                if (typeof openServiceberichtModal === 'function') {
                    openServiceberichtModal();

                    // Set the title in the form
                    const titleEl = document.getElementById('service-report-title');
                    if (titleEl) titleEl.value = title;
                }
            };

            // --- CALENDAR SYSTEM ---
            window.calendarState = {
                currentView: 'month',
                currentDate: new Date(),
                events: []
            };

            window.switchCalendarView = function (view) {
                window.calendarState.currentView = view;
                const tabs = document.querySelectorAll('.calendar-tab-btn');
                tabs.forEach(btn => {
                    const btnTarget = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
                    btn.classList.toggle('active', btnTarget === view);
                });
                renderCalendar();
            };

            window.prevCalendar = function () {
                const d = window.calendarState.currentDate;
                if (window.calendarState.currentView === 'month') d.setMonth(d.getMonth() - 1);
                else if (window.calendarState.currentView === 'week') d.setDate(d.getDate() - 7);
                else if (window.calendarState.currentView === 'day') d.setDate(d.getDate() - 1);
                else if (window.calendarState.currentView === 'year') d.setFullYear(d.getFullYear() - 1);
                renderCalendar();
            };

            window.nextCalendar = function () {
                const d = window.calendarState.currentDate;
                if (window.calendarState.currentView === 'month') d.setMonth(d.getMonth() + 1);
                else if (window.calendarState.currentView === 'week') d.setDate(d.getDate() + 7);
                else if (window.calendarState.currentView === 'day') d.setDate(d.getDate() + 1);
                else if (window.calendarState.currentView === 'year') d.setFullYear(d.getFullYear() + 1);
                renderCalendar();
            };

            window.todayCalendar = function () {
                window.calendarState.currentDate = new Date();
                renderCalendar();
            };

            async function fetchCalendarEvents() {
                if (!supabaseClient) return [];

                // Fetch hard events from maintenance_events
                const { data: maintEvents, error: e1 } = await supabaseClient
                    .from('maintenance_events')
                    .select('*, machines(name, manufacturer, serial, year)');

                // Fetch calculated events from machines (next maintenance)
                const { data: machines, error: e2 } = await supabaseClient
                    .from('machines')
                    .select('id, name, manufacturer, next_maintenance, serial, year')
                    .not('next_maintenance', 'is', null);

                let allEvents = [];

                if (maintEvents) {
                    maintEvents.forEach(ev => {
                        const m = ev.machines;
                        const titleParts = m ? [
                            m.manufacturer,
                            m.name,
                            m.serial ? `#${m.serial}` : null,
                            m.year ? `(${m.year})` : null
                        ].filter(Boolean) : [];

                        const fullTitle = ev.title || (titleParts.length > 0 ? titleParts.join(' ') : 'Wartung');

                        allEvents.push({
                            id: ev.id,
                            title: fullTitle,
                            date: new Date(ev.event_date),
                            type: 'manual',
                            machineId: ev.machine_id
                        });
                    });
                }

                if (machines) {
                    machines.forEach(m => {
                        const titleParts = [
                            m.manufacturer,
                            m.name,
                            m.serial ? `#${m.serial}` : null,
                            m.year ? `(${m.year})` : null
                        ].filter(Boolean);

                        const fullTitle = titleParts.length > 0 ? titleParts.join(' ') : 'Wartung';

                        allEvents.push({
                            id: 'maint-' + m.id,
                            title: fullTitle,
                            date: new Date(m.next_maintenance),
                            className: 'event-maintenance',
                            machineId: m.id
                        });
                    });
                }

                return allEvents;
            }

            window.renderCalendar = async function () {
                const container = document.getElementById('calendar-container');
                if (!container) return;

                const events = await fetchCalendarEvents();
                const view = window.calendarState.currentView;
                const date = window.calendarState.currentDate;

                // --- Apply Search & Filter ---
                const searchQuery = (document.getElementById('calendar-search-input')?.value || '').toLowerCase();
                const selectedCatId = window.calendarState.selectedCategoryId;

                let filteredEvents = events;

                if (searchQuery) {
                    filteredEvents = filteredEvents.filter(e => e.title.toLowerCase().includes(searchQuery));
                }

                if (selectedCatId) {
                    filteredEvents = filteredEvents.filter(e => {
                        const m = (window.machineList || []).find(mm => mm.id === e.machineId);
                        return m && m.category_id === parseInt(selectedCatId);
                    });
                }

                container.innerHTML = '';

                if (view === 'month') renderMonthView(container, date, filteredEvents);
                else if (view === 'week') renderWeekView(container, date, filteredEvents);
                else if (view === 'day') renderDayView(container, date, filteredEvents);
                else if (view === 'year') renderYearView(container, date, filteredEvents);
            };

            // Global Initialization for Calendar Filters
            document.addEventListener('DOMContentLoaded', () => {
                const searchInput = document.getElementById('calendar-search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', () => renderCalendar());
                }

                const filterTrigger = document.getElementById('calendar-category-filter-trigger');
                if (filterTrigger) {
                    filterTrigger.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const menu = document.getElementById('calendar-category-filter-menu');
                        if (menu) {
                            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                            if (menu.style.display === 'block') populateCalendarCategoryFilter();
                        }
                    });
                }

                document.addEventListener('click', () => {
                    const menu = document.getElementById('calendar-category-filter-menu');
                    if (menu) menu.style.display = 'none';
                });
            });

            function populateCalendarCategoryFilter() {
                const list = document.getElementById('calendar-category-filter-options');
                if (!list) return;

                list.innerHTML = `<li onclick="selectCalendarCategory(null, 'Alle Kategorien')">Alle Kategorien</li>`;

                const machineCats = (window.categoryList || []).filter(c => c.type === 'machine');
                machineCats.forEach(cat => {
                    const li = document.createElement('li');
                    li.textContent = cat.name;
                    li.onclick = (e) => {
                        e.stopPropagation();
                        selectCalendarCategory(cat.id, cat.name);
                    };
                    list.appendChild(li);
                });
            }

            window.selectCalendarCategory = function (id, name) {
                window.calendarState.selectedCategoryId = id;
                const label = document.getElementById('calendar-current-category-name');
                if (label) label.textContent = name;

                const menu = document.getElementById('calendar-category-filter-menu');
                if (menu) menu.style.display = 'none';

                renderCalendar();
            };

            function renderMonthView(container, date, events) {
                const year = date.getFullYear();
                const month = date.getMonth();

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);

                // Adjust for Monday start (0=Sun, 1=Mon... -> Monday=0)
                let startOffset = firstDay.getDay() - 1;
                if (startOffset === -1) startOffset = 6;

                const monthName = date.toLocaleString('de-DE', { month: 'long', year: 'numeric' });

                let html = `
                    <div class="calendar-grid-container">
                        <div style="padding: 1rem 1.5rem; background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.05); font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;">
                            ${monthName}
                        </div>
                        <div class="calendar-header-row">
                            <div class="calendar-header-day">MO</div>
                            <div class="calendar-header-day">DI</div>
                            <div class="calendar-header-day">MI</div>
                            <div class="calendar-header-day">DO</div>
                            <div class="calendar-header-day">FR</div>
                            <div class="calendar-header-day">SA</div>
                            <div class="calendar-header-day">SO</div>
                        </div>
                        <div class="calendar-grid">
                `;

                // Prev month days
                const prevMonthLastDay = new Date(year, month, 0).getDate();
                for (let i = startOffset - 1; i >= 0; i--) {
                    html += `<div class="calendar-cell other-month"><div class="calendar-date-num">${prevMonthLastDay - i}</div></div>`;
                }

                // Current month days
                const today = new Date();
                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const currentLoopDate = new Date(year, month, d);
                    const isToday = currentLoopDate.toDateString() === today.toDateString();

                    const dayEvents = events.filter(e => e.date.toDateString() === currentLoopDate.toDateString());

                    let eventsHtml = '<div class="calendar-event-list">';
                    dayEvents.forEach(e => {
                        const typeClass = e.type === 'maintenance' ? 'maintenance' : '';
                        eventsHtml += `<div class="calendar-event-pill ${typeClass}" 
                                            title="${e.title}" 
                                            draggable="true" 
                                            ondragstart="handleCalendarDragStart(event, '${e.machineId}')"
                                            onclick="handleCalendarEventClick('${e.machineId}')"
                                            style="cursor: grab;">${e.title}</div>`;
                    });
                    eventsHtml += '</div>';

                    const yyyyL = currentLoopDate.getFullYear();
                    const mmL = String(currentLoopDate.getMonth() + 1).padStart(2, '0');
                    const ddL = String(currentLoopDate.getDate()).padStart(2, '0');
                    const localDateStr = `${yyyyL}-${mmL}-${ddL}`;

                    html += `
                            <div class="calendar-cell ${isToday ? 'today' : ''}" 
                                 ondragover="event.preventDefault(); this.style.background='rgba(59, 130, 246, 0.05)'" 
                                 ondragleave="this.style.background=''"
                                 ondrop="handleCalendarDrop(event, '${localDateStr}')">
                                <div class="calendar-date-num">${d}</div>
                                ${eventsHtml}
                            </div>
                        `;
                }

                // Next month days
                const totalCells = Math.ceil((startOffset + lastDay.getDate()) / 7) * 7;
                const nextDays = totalCells - (startOffset + lastDay.getDate());
                for (let i = 1; i <= nextDays; i++) {
                    html += `<div class="calendar-cell other-month"><div class="calendar-date-num">${i}</div></div>`;
                }

                html += `</div></div>`;
                container.innerHTML = html;
            }

            function renderWeekView(container, date, events) {
                // Simplified week view for now
                container.innerHTML = '<div style="padding: 3rem; text-align: center; color: rgba(255,255,255,0.5);">Wochenansicht wird geladen...</div>';
                setTimeout(() => {
                    const startOfWeek = new Date(date);
                    const day = startOfWeek.getDay() || 7;
                    startOfWeek.setDate(startOfWeek.getDate() - (day - 1));

                    let html = `<div class="calendar-grid-container"><div class="calendar-header-row"><div class="calendar-header-day">Zeit</div>`;
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(startOfWeek);
                        d.setDate(d.getDate() + i);
                        html += `<div class="calendar-header-day">${d.toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric' })}</div>`;
                    }
                    html += `</div><div class="calendar-week-grid"><div class="calendar-time-col">`;
                    for (let h = 8; h <= 18; h++) {
                        html += `<div class="calendar-time-cell">${h}:00</div>`;
                    }
                    html += `</div>`;

                    for (let i = 0; i < 7; i++) {
                        html += `<div class="calendar-week-day-col">`;
                        for (let h = 8; h <= 18; h++) {
                            html += `<div class="calendar-week-slot"></div>`;
                        }
                        html += `</div>`;
                    }
                    html += `</div></div>`;
                    container.innerHTML = html;
                }, 100);
            }

            function renderDayView(container, date, events) {
                container.innerHTML = `<div style="padding: 3rem; text-align: center; color: rgba(255,255,255,0.5);">Tagesansicht für ${date.toLocaleDateString('de-DE')}</div>`;
            }

            function renderYearView(container, date, events) {
                const year = date.getFullYear();
                let html = `<div class="calendar-year-grid">`;
                for (let m = 0; m < 12; m++) {
                    const monthDate = new Date(year, m, 1);
                    const monthName = monthDate.toLocaleString('de-DE', { month: 'long' });

                    html += `
                        <div class="calendar-month-mini">
                            <div class="calendar-month-mini-title">${monthName}</div>
                            <div class="calendar-mini-grid">
                    `;

                    const firstDay = new Date(year, m, 1);
                    let startOffset = firstDay.getDay() - 1;
                    if (startOffset === -1) startOffset = 6;

                    for (let i = 0; i < startOffset; i++) {
                        html += `<div class="calendar-mini-cell"></div>`;
                    }

                    const lastDay = new Date(year, m + 1, 0).getDate();
                    for (let d = 1; d <= lastDay; d++) {
                        const currentLoopDate = new Date(year, m, d);
                        const dayEvents = events.filter(e => e.date.toDateString() === currentLoopDate.toDateString());
                        const hasEvent = dayEvents.length > 0;
                        const onclick = hasEvent ? `onclick="handleCalendarEventClick('${dayEvents[0].machineId}')"` : '';
                        html += `<div class="calendar-mini-cell ${hasEvent ? 'has-event' : ''}" ${onclick} style="${hasEvent ? 'cursor: pointer;' : ''}">${d}</div>`;
                    }

                    html += `</div></div>`;
                }
                html += `</div>`;
                container.innerHTML = html;
            }

            async function fetchServiceEntries() {
                if (!supabaseClient) return;

                const list = document.getElementById('service-entries-list');
                if (list) list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: white;">Lade Serviceeinsätze...</div>';

                const { data, error } = await supabaseClient
                    .from('service_entries')
                    .select('*')
                    .order('date', { ascending: false });

                if (error) {
                    console.error('Error fetching service entries:', error);
                    if (list) list.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: rgba(255,200,200,0.8);">
                            Fehler beim Laden: ${error.message}</div>`;
                    return;
                }

                allServiceEntries = data || [];
                renderServiceEntries();
            }

            window.openEditServicebericht = function (id) {
                // Find entry (if not passed directly, though openEditServicebericht is usually called with ID)
                const entry = allServiceEntries.find(e => e.id === id);
                if (!entry) return;

                openServiceberichtModal(entry); // Prepare modal
            };

            // Existing function needs update to handle files
            window.openServiceberichtModal = function (editData = null) {
                try {
                    const modal = document.getElementById('servicebericht-modal');
                    if (modal) {
                        modal.classList.remove('hidden');
                        modal.style.display = 'flex';
                        requestAnimationFrame(() => {
                            modal.classList.add('show');
                        });

                        const titleEl = modal.querySelector('h2');
                        const machineSelector = modal.querySelector('.machine-selector-wrapper .search-input-container');
                        const machineList = document.getElementById('service-machine-list');
                        const lockHint = document.getElementById('selection-lock-hint');
                        const previewArea = document.getElementById('selected-machine-preview');

                        // Reset form
                        const form = document.getElementById('servicebericht-form');
                        if (form) form.reset();

                        const selectedMachineId = document.getElementById('selected-machine-id');
                        if (selectedMachineId) selectedMachineId.value = '';

                        if (previewArea) {
                            previewArea.classList.add('hidden');
                            previewArea.style.display = 'none';
                        }
                        if (lockHint) lockHint.classList.add('hidden');
                        if (machineSelector) machineSelector.style.display = 'block';
                        if (machineList) machineList.style.display = 'block';

                        const selectedTechIds = document.getElementById('selected-technician-ids');
                        if (selectedTechIds) selectedTechIds.value = '';

                        const filePreviews = document.getElementById('service-file-previews');
                        if (filePreviews) filePreviews.innerHTML = '';

                        serviceFiles = []; // Reset new files
                        existingServiceFiles = []; // Reset existing files

                        selectedTechs = []; // Reset selected technicians

                        if (editData) {
                            currentEditingServiceId = editData.id;
                            if (titleEl) titleEl.textContent = 'Servicebericht bearbeiten';

                            // Populate fields
                            const reportTitle = document.getElementById('service-report-title');
                            if (reportTitle) reportTitle.value = editData.title || '';

                            const dateStart = document.getElementById('service-date-start');
                            if (dateStart) dateStart.value = editData.date || '';

                            const description = document.getElementById('service-description');
                            if (description) description.value = editData.description || '';

                            // Populate machine
                            if (editData.machine_id) {
                                const m = (window.machineList || []).find(x => x.id === editData.machine_id);
                                if (m) {
                                    const cat = (window.categoryList || []).find(c => c.id === m.category_id);
                                    selectServiceMachine(m.id, m.manufacturer, m.name, m.serial, m.image_url, cat ? cat.name : '', m.year);
                                }
                            }

                            // Populate technicians
                            if (editData.technicians && Array.isArray(editData.technicians)) {
                                selectedTechs = [...editData.technicians];
                                if (selectedTechIds) selectedTechIds.value = JSON.stringify(selectedTechs);
                            }

                            // Populate files
                            if (editData.files && Array.isArray(editData.files)) {
                                // Copy to existingServiceFiles
                                existingServiceFiles = [...editData.files];
                                if (typeof renderServiceFilePreviews === 'function') renderServiceFilePreviews();
                            }

                            // Lock Machine Selection
                            if (machineSelector) machineSelector.style.display = 'none';
                            if (machineList) machineList.style.display = 'none';
                            if (lockHint) lockHint.classList.remove('hidden');

                        } else {
                            currentEditingServiceId = null;
                            if (titleEl) titleEl.textContent = 'Neuer Servicebericht';

                            // Pre-select machine if opened from Machine Details context
                            if (typeof currentSelectedMachineForService !== 'undefined' && currentSelectedMachineForService) {
                                const machines = window.machineList || [];
                                const m = machines.find(x => x.id === currentSelectedMachineForService);
                                if (m) {
                                    const cat = (window.categoryList || []).find(c => c.id === m.category_id);
                                    const catName = cat ? cat.name : 'Unkategorisiert';
                                    setTimeout(() => {
                                        if (typeof selectServiceMachine === 'function') {
                                            selectServiceMachine(m.id, m.manufacturer, m.name, m.serial, m.image_url, catName, m.year);
                                        }
                                    }, 100);
                                }
                            }
                        }

                        // Populate initial lists
                        if (typeof window.machineList !== 'undefined') renderServiceMachineList();
                        if (typeof userList !== 'undefined') renderServiceTechnicianList();
                    }
                } catch (error) {
                    console.error('Error opening service report modal:', error);
                    alert('Fehler beim Öffnen des Formulars: ' + error.message);
                }
            };


            window.renderServiceEntries = function () {
                try {
                    const list = document.getElementById('service-entries-list');
                    const searchInput = document.getElementById('service-search-input');
                    if (!list) return;

                    let entries = allServiceEntries;

                    // Filter by Search
                    if (searchInput && searchInput.value.trim() !== '') {
                        const term = searchInput.value.toLowerCase();
                        entries = entries.filter(e => {
                            const machines = window.machineList || [];
                            const machine = machines.find(m => m.id === e.machine_id);
                            const machineName = machine ? `${machine.manufacturer} ${machine.name} ${machine.serial || ''} ${machine.year ||
                                ''}` : '';

                            const text = `${e.title} ${e.description} ${e.date} ${machineName}`.toLowerCase();

                            // Split search term into words and check if ALL words are present
                            const status = term.split(' ').every(word => text.includes(word));
                            return status;
                        });
                    }

                    if (entries.length === 0) {
                        list.innerHTML = `
        <div class="empty-state"
            style="grid-column: 1 / -1; text-align: center; padding: 4rem 2rem; background: rgba(255,255,255,0.02); border-radius: 24px; border: 1px dashed rgba(255,255,255,0.1);">
            <p style="color: rgba(255,255,255,0.4); font-size: 1.1rem;">Keine Serviceeinsätze gefunden.</p>
        </div>`;
                        return;
                    }

                    list.innerHTML = entries.map(e => {
                        const machines = window.machineList || [];
                        const machine = machines.find(m => m.id === e.machine_id);
                        const machineImg = machine ? (machine.image_url || '') : '';
                        const dateObj = new Date(e.date);
                        const dateStr = dateObj.toLocaleDateString('de-DE');

                        // File icons logic
                        let filesHtml = '';
                        if (e.files && Array.isArray(e.files) && e.files.length > 0) {
                            filesHtml = `<div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">`;
                            e.files.forEach(file => {
                                // Backward compatibility check
                                const isLegacy = typeof file === 'string';
                                const url = isLegacy ? file : file.url;
                                const name = isLegacy ? 'Datei' : file.name;
                                const type = isLegacy ? '?' : file.type;

                                const isImg = url.match(/\.(jpg|jpeg|png|gif|webp)$/i) || (type && type.startsWith('image/'));

                                if (isImg) {
                                    filesHtml += `<a href="${url}" target="_blank" title="${name}"
                style="display: block; width: 32px; height: 32px; border-radius: 6px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);"><img
                    src="${url}" style="width: 100%; height: 100%; object-fit: cover;"></a>`;
                                } else if (type === 'application/pdf' || url.endsWith('.pdf')) {
                                    filesHtml += `<a href="${url}" target="_blank" title="${name}"
                style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: white;"><svg
                    width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                </svg></a>`;
                                } else {
                                    filesHtml += `<a href="${url}" target="_blank" title="${name}"
                style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: white;"><svg
                    width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                </svg></a>`;
                                }
                            });
                            filesHtml += `</div>`;
                        }

                        return `
                            <div class="card"
                    style="display: flex; flex-direction: column; overflow: hidden; position: relative; transition: transform 0.2s; min-height: 140px;">
                        <div style="padding: 1.5rem; display: flex; gap: 1.5rem; align-items: start; height: 100%;">
                            <div
                                style="width: 110px; height: 110px; border-radius: 18px; background: rgba(255,255,255,0.05); overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1);">
                                ${machineImg ? `<img src="${machineImg}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                `<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5;">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>`}
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 10px;">
                                    <h3
                                        style="margin: 0; font-size: 1.25rem; color: white; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${e.title}</h3>
                                    <span
                                        style="font-size: 0.9rem; color: rgba(255,255,255,0.4); font-weight: 600; white-space: nowrap;">${dateStr}</span>
                                </div>
                                <div
                                    style="color: var(--color-primary-green); font-size: 0.95rem; font-weight: 700; margin-bottom: 10px;">
                                    ${machine ? `${machine.manufacturer} ${machine.name} #${machine.serial || '?'} (${machine.year
                                || '?'})` : 'Unbekannte Maschine'}
                                </div>
                                <p
                                    style="margin: 0; font-size: 0.95rem; color: rgba(255,255,255,0.5); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; font-weight: 500;">
                                    ${e.description}
                                </p>
                                ${filesHtml}
                                <div style="margin-top: 1rem; display: flex; gap: 12px; justify-content: flex-end;">
                                    <button onclick="openEditServicebericht(${e.id})" title="Bearbeiten"
                                        style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; transition: all 0.2s;"
                                        onmouseover="this.style.background='rgba(59,130,246,0.1)'; this.style.borderColor='rgba(59,130,246,0.2)'"
                                        onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(255,255,255,0.1)'">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        Bearbeiten
                                    </button>
                                    <button onclick="deleteServiceEntry(${e.id})" title="Löschen"
                                        style="background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.1); color: #ef4444; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; transition: all 0.2s;"
                                        onmouseover="this.style.background='rgba(239, 68, 68, 0.15)'"
                                        onmouseout="this.style.background='rgba(239, 68, 68, 0.05)'">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path
                                                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2">
                                            </path>
                                        </svg>
                                        Löschen
                                    </button>
                                </div>
                            </div>
                        </div >
        </div >
        `;
                    }).join('');
                } catch (error) {
                    console.error('Error rendering service entries:', error);
                }
            };

            // Init Search Listener
            document.addEventListener('DOMContentLoaded', () => {
                const searchInput = document.getElementById('service-search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', () => renderServiceEntries());
                }

                // Fetch when clicking nav link
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    if (link.getAttribute('data-target') === 'service') {
                        link.addEventListener('click', () => {
                            // Reset search if not coming from "View Reports" action?
                            // For now, let's keep search if it's there, or maybe clear it if user wants to see all.
                            // Better UX: If filter is active, maybe keep it? But user might want to see all.
                            // Let's NOT clear it automatically here to allow "View Reports" to work effectively.
                            // But we MUST fetch.
                            fetchServiceEntries();
                        });
                    }
                });
            });

            // Override submit to refresh list
            // We need to capture the original function reference appropriately
            // Since submitServicebericht was defined on window, we can wrap it.
            const originalSubmitServicebericht = window.submitServicebericht;
            window.submitServicebericht = async function () {
                try {
                    await originalSubmitServicebericht();
                    fetchServiceEntries(); // Refresh list after save
                } catch (e) {
                    console.error(e);
                }
            };


            // Persistence on load
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                const s = document.getElementById('sidebar');
                const m = document.getElementById('main-wrapper');
                if (s) s.classList.add('collapsed');
                if (m) m.classList.add('collapsed-sidebar');
            }
        </script>
        <!-- Modal: Service Action Choice (View or Create) - Moved to root for better centering -->
        <div id="service-action-modal" class="modal-backdrop hidden">
            <div class="modal-content" style="max-width: 450px; padding: 1.5rem;">
                <h2 style="margin-bottom: 1.25rem; font-size: 1.4rem;">Aktionen für Maschine</h2>

                <!-- Section 1: Create -->
                <div class="accordion-section" style="margin-bottom: 1rem;">
                    <h3 onclick="toggleAccordion('create-section')"
                        style="font-size: 0.8rem; color: rgba(255,255,255,0.4); text-transform: uppercase; margin-bottom: 0.75rem; letter-spacing: 1px; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; user-select: none;">
                        <span>Anlegen</span>
                        <svg id="create-section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                            style="transition: transform 0.3s; transform: rotate(-90deg);">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </h3>
                    <div id="create-section" class="accordion-content"
                        style="display: grid; gap: 0.6rem; margin-bottom: 0.5rem; max-height: 0px; overflow: hidden; transition: max-height 0.3s ease, opacity 0.3s ease; opacity: 0;">
                        <button class="report-type-btn compact" onclick="startReportCreation('servicebericht')">
                            <div class="icon-small">📄</div>
                            <div class="text"><strong>Servicebericht</strong></div>
                        </button>
                        <button class="report-type-btn compact" onclick="startReportCreation('eingangsprotokoll')">
                            <div class="icon-small">📥</div>
                            <div class="text"><strong>Eingangsprotokoll</strong></div>
                        </button>
                        <button class="report-type-btn compact" onclick="startReportCreation('abnahmeprotokoll')">
                            <div class="icon-small">✅</div>
                            <div class="text"><strong>Abnahmeprotokoll</strong></div>
                        </button>
                    </div>
                </div>

                <!-- Section 2: View -->
                <div class="accordion-section" style="margin-bottom: 1rem;">
                    <h3 onclick="toggleAccordion('view-section')"
                        style="font-size: 0.8rem; color: rgba(255,255,255,0.4); text-transform: uppercase; margin-bottom: 0.75rem; letter-spacing: 1px; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; user-select: none;">
                        <span>Ansehen</span>
                        <svg id="view-section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                            style="transition: transform 0.3s; transform: rotate(-90deg);">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </h3>
                    <div id="view-section" class="accordion-content"
                        style="display: grid; gap: 0.6rem; max-height: 0px; overflow: hidden; transition: max-height 0.3s ease, opacity 0.3s ease; opacity: 0;">
                        <button class="report-type-btn compact secondary"
                            onclick="showServiceReportsForCurrentMachine('Servicebericht')">
                            <div class="icon-small">📄</div>
                            <div class="text"><strong>Servicebericht</strong></div>
                        </button>
                        <button class="report-type-btn compact secondary"
                            onclick="showServiceReportsForCurrentMachine('Eingangsprotokoll')">
                            <div class="icon-small">📥</div>
                            <div class="text"><strong>Eingangsprotokoll</strong></div>
                        </button>
                        <button class="report-type-btn compact secondary"
                            onclick="showServiceReportsForCurrentMachine('Abnahmeprotokoll')">
                            <div class="icon-small">✅</div>
                            <div class="text"><strong>Abnahmeprotokoll</strong></div>
                        </button>
                    </div>
                </div>

                <div class="modal-actions" style="margin-top: 1.5rem; justify-content: center;">
                    <button class="btn-secondary" style="width: 100%; border-radius: 12px; font-size: 0.9rem;"
                        onclick="closeServiceActionModal()">Abbrechen</button>
                </div>
            </div>
        </div>

        <script>
            // Accordion toggle function
            window.toggleAccordion = function (sectionId) {
                const content = document.getElementById(sectionId);
                const icon = document.getElementById(sectionId + '-icon');

                if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
                    // Open
                    content.style.maxHeight = '500px';
                    content.style.opacity = '1';
                    if (icon) icon.style.transform = 'rotate(0deg)';
                } else {
                    // Close
                    content.style.maxHeight = '0px';
                    content.style.opacity = '0';
                    if (icon) icon.style.transform = 'rotate(-90deg)';
                }
            };
        </script>

        <!-- Modal 1: Select Report Type -->
        <div id="report-type-modal" class="modal-backdrop hidden">
            <div class="modal-content" style="max-width: 500px;">
                <h2>Was möchten Sie anlegen?</h2>
                <div class="report-type-options" style="display: grid; gap: 1rem; margin-top: 1.5rem;">
                    <button class="report-type-btn" onclick="startReportCreation('servicebericht')">
                        <div class="icon">📄</div>
                        <div class="text">
                            <strong>Servicebericht</strong>
                            <span>Standard Wartung oder Reparatur</span>
                        </div>
                    </button>
                    <button class="report-type-btn" onclick="startReportCreation('eingangsprotokoll')">
                        <div class="icon">📥</div>
                        <div class="text">
                            <strong>Eingangsprotokoll</strong>
                            <span>Checkliste bei Maschinenankunft</span>
                        </div>
                    </button>
                    <button class="report-type-btn" onclick="startReportCreation('abnahmeprotokoll')">
                        <div class="icon">✅</div>
                        <div class="text">
                            <strong>Abnahmeprotokoll</strong>
                            <span>Übergabe an den Kunden</span>
                        </div>
                    </button>
                </div>
                <div class="modal-actions" style="margin-top: 2rem;">
                    <button class="btn-secondary" onclick="closeReportTypeModal()">Abbrechen</button>
                </div>
            </div>
        </div>

        <!-- Modal 2: Create Servicebericht Form -->
        <div id="servicebericht-modal" class="modal-backdrop hidden">
            <div class="modal-content" style="max-width: 800px; width: 95%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="margin: 0;">Neuer Servicebericht</h2>
                    <button class="btn-close-modal" onclick="closeServiceberichtModal()">&times;</button>
                </div>

                <div class="modal-scroll-area">
                    <form id="servicebericht-form">
                        <input type="hidden" id="service-report-title" value="Servicebericht">
                        <!-- Step 1: Machine Selection -->
                        <div class="form-section">
                            <label>Maschine auswählen</label>
                            <div class="machine-selector-wrapper">
                                <div class="search-input-container">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    </svg>
                                    <input type="text" id="service-machine-search" class="glass-form-input"
                                        placeholder="Maschine suchen..." oninput="filterServiceMachines()">
                                </div>
                                <div id="service-machine-list" class="selectable-list">
                                    <!-- Machines populated via JS -->
                                </div>
                                <input type="hidden" id="selected-machine-id" required>

                                <!-- Machine Preview (Restored) -->
                                <div id="selected-machine-preview" class="hidden"
                                    style="margin-top: 1.5rem; padding: 1.5rem; background: rgba(0, 150, 64, 0.1); border: 2px solid var(--color-primary-green); border-radius: 16px; position: relative;">
                                    <div id="selection-lock-hint" class="hidden"
                                        style="position: absolute; top: -12px; right: 20px; background: var(--color-primary-green); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                        </svg>
                                        FIXIERT
                                    </div>
                                    <div style="display: flex; gap: 1.5rem; align-items: center;">
                                        <div id="preview-image"
                                            style="width: 80px; height: 80px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; background: rgba(255,255,255,0.05);">
                                        </div>
                                        <div>
                                            <div id="preview-name"
                                                style="font-weight: 800; font-size: 1.1rem; color: white;">
                                            </div>
                                            <div id="preview-serial"
                                                style="color: rgba(255,255,255,0.5); font-size: 0.9rem; margin-top: 4px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Date and Description -->
                        <div class="form-row"
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                            <div class="form-group">
                                <label for="service-date-start">Datum (von)</label>
                                <input type="date" id="service-date-start" class="glass-form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="service-date-end">Datum (bis) - Optional</label>
                                <input type="date" id="service-date-end" class="glass-form-input">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="service-next-maintenance-override"
                                style="color: var(--secondary-green); font-weight: 800;">Manuelles Datum für NÄCHSTE
                                Wartung (Optional)</label>
                            <p style="font-size: 0.75rem; color: rgba(255,255,255,0.4); margin-bottom: 8px;">Leer lassen
                                für automatische Berechnung basierend auf der Kategorie.</p>
                            <input type="date" id="service-next-maintenance-override" class="glass-form-input"
                                style="border-color: rgba(16, 185, 129, 0.3);">
                        </div>

                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="service-description">Kurzbeschreibung des Einsatzes</label>
                            <textarea id="service-description" rows="4" class="glass-form-input"
                                placeholder="Was wurde gemacht?" required></textarea>
                        </div>

                        <!-- Step 3: Technician Selection -->
                        <div class="form-section" style="margin-top: 1.5rem;">
                            <label>Techniker auswählen</label>
                            <div id="technician-selection-grid" class="pill-grid">
                                <!-- Technicians populated via JS -->
                            </div>
                            <input type="hidden" id="selected-technician-ids">
                        </div>

                        <!-- Step 4: File Upload -->
                        <div class="form-section" style="margin-top: 1.5rem;">
                            <label>Bilder & Dokumente</label>
                            <div class="file-drop-zone" id="service-file-dropzone">
                                <input type="file" id="service-file-input" multiple class="hidden-file-input">
                                <div class="drop-zone-content">
                                    <span class="icon">📁</span>
                                    <p>Dateien hierher ziehen oder klicken</p>
                                </div>
                            </div>
                            <div id="service-file-previews" class="file-preview-grid"></div>
                        </div>
                    </form>
                </div>

                <div class="modal-actions"
                    style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem; margin-top: 2rem;">
                    <button class="btn-secondary" onclick="closeServiceberichtModal()">Abbrechen</button>
                    <button class="btn-primary" onclick="submitServicebericht()">Bericht speichern</button>
                </div>
            </div>
        </div>

        <!-- Custom Modal for Adding Categories -->
        <div id="category-modal" class="modal-backdrop hidden">
            <div class="modal-content" style="max-width: 600px;">
                <input type="hidden" id="cat-modal-id">
                <h2 id="cat-modal-title">Neue Kategorie</h2>

                <div class="modal-form-area">
                    <div class="form-group">
                        <label for="cat-name-input">Name der Kategorie</label>
                        <input type="text" id="cat-name-input" class="glass-input"
                            placeholder="z.B. Häcksler oder Wartung">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="margin-bottom: 15px; display: block;">Kategorie-Typ</label>
                        <div class="segmented-control">
                            <label class="segmented-option">
                                <input type="radio" name="cat-type" value="machine" checked>
                                <span class="option-text">Maschine</span>
                            </label>
                            <label class="segmented-option">
                                <input type="radio" name="cat-type" value="service">
                                <span class="option-text">Service</span>
                            </label>
                            <label class="segmented-option">
                                <input type="radio" name="cat-type" value="contact">
                                <span class="option-text">Kontaktart</span>
                            </label>
                        </div>
                    </div>

                    <div id="cat-interval-group" class="form-group" style="margin-top: 1.5rem;">
                        <label for="cat-interval-input">Standard-Wartungsintervall (Monate)</label>
                        <input type="number" id="cat-interval-input" class="glass-input" placeholder="z.B. 12" min="1"
                            value="12">
                    </div>
                </div>

                <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button id="cancel-cat-btn" class="btn-secondary">Abbrechen</button>
                    <button id="save-cat-btn" class="btn-primary">Speichern</button>
                </div>
            </div>
        </div>

        <!-- Add Machine Modal -->
        <div id="add-machine-modal" class="modal-backdrop hidden">
            <div class="modal-content"
                style="max-width: 900px; width: 90%; max-height: 85vh; display: flex; flex-direction: column; position: relative; margin: auto;">
                <h2 style="margin-bottom: 2rem;">Maschine anlegen</h2>
                <div style="position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; line-height: 1;"
                    onclick="closeAddMachineModal()">&times;</div>

                <div class="modal-form-area" style="overflow-y: auto; padding-right: 10px; flex: 1;">
                    <!-- Interactive Image Slot at the Top -->
                    <div id="machine-image-slot" class="machine-modal-image-slot"
                        onclick="document.getElementById('machine-image-upload').click()">
                        <div class="placeholder-content-inner"
                            style="display: flex; flex-direction: column; align-items: center; gap: 12px; pointer-events: none;">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;">
                                <path
                                    d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" />
                                <circle cx="12" cy="13" r="3" />
                            </svg>
                            <span class="placeholder-text"
                                style="font-size: 0.9rem; color: rgba(255,255,255,0.4); font-weight: 500;">Foto
                                hinzufügen</span>
                        </div>
                    </div>

                    <!-- File Previews Grid (Moved here) -->
                    <div id="machine-file-previews" class="file-preview-grid" style="margin-bottom: 2rem;"></div>

                    <h3 class="section-title">1. Stammdaten</h3>

                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Maschinentyp / Kategorie</label>
                            <div id="category-wrapper" style="position: relative;">
                                <div id="machine-category-trigger" class="glass-select"
                                    style="cursor: pointer; display: flex; align-items: center; justify-content: space-between;"
                                    onclick="toggleCategoryDropdown(event)">
                                    <span id="machine-category-text">Bitte wählen...</span>
                                </div>
                                <input type="hidden" id="machine-category">

                                <div id="machine-category-dropdown" class="user-dropdown-menu"
                                    style="width: 100%; top: 105%; right: auto; left: 0;">
                                    <ul id="machine-category-list">
                                        <!-- Populated by JS -->
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Hersteller</label>
                            <input type="text" id="machine-manufacturer" class="glass-input"
                                placeholder="z.B. meetra, BACKHUS">
                        </div>

                        <div class="form-group">
                            <label>Typbezeichnung</label>
                            <input type="text" id="machine-name" placeholder="z.B. 17.50">
                        </div>

                        <div class="form-group">
                            <label>Seriennummer / Fahrgestellnummer</label>
                            <input type="text" id="machine-serial" placeholder="SN-12345678">
                        </div>

                        <div class="form-group">
                            <label>Baujahr</label>
                            <input type="number" id="machine-year" placeholder="2024"
                                style="width: 100%; padding: 14px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: white; font-family: 'Inter'; backdrop-filter: blur(16px);">
                        </div>

                        <div class="form-group">
                            <label>Art des Kontaktes</label>
                            <div id="contact-wrapper" style="position: relative;">
                                <div id="contact-trigger" class="glass-select"
                                    style="cursor: pointer; display: flex; align-items: center; justify-content: space-between;"
                                    onclick="toggleContactDropdown(event)">
                                    <span id="contact-text"
                                        style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%;">Bitte
                                        wählen...</span>
                                </div>
                                <input type="hidden" id="machine-contact-type">

                                <div id="contact-dropdown" class="user-dropdown-menu"
                                    style="width: 100%; top: 105%; right: auto; left: 0;">
                                    <ul id="contact-list">
                                        <!-- Populated via JS -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="section-title" style="margin-top: 2rem;">2. Wartung</h3>
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Letzte Wartung</label>
                            <input type="date" id="machine-last-maintenance" class="glass-input">
                        </div>
                        <div class="form-group" style="position: relative;">
                            <label style="display: flex; justify-content: space-between; align-items: center;">
                                Nächste Wartung
                                <span id="maint-auto-badge" class="badge hidden"
                                    style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); font-size: 0.7rem; padding: 2px 6px; border-radius: 6px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase;">Auto</span>
                            </label>
                            <input type="date" id="machine-next-maintenance" class="glass-input">
                        </div>
                    </div>

                    <h3 class="section-title" style="margin-top: 2rem;">3. Standort & Besitzer</h3>
                    <div class="form-group">
                        <label>Firma / Besitzer / Verantwortliche</label>
                        <input type="text" id="machine-owner" placeholder="Name des Besitzers">
                    </div>

                    <div class="form-group">
                        <label>Betreiberstandort (Karte öffnen)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="machine-address-input" placeholder="Straße, PLZ, Stadt, Land"
                                style="flex:1;"
                                oninput="debounceSearchAddress('machine-address-input', 'address-suggestions')">
                            <button type="button" class="btn-secondary"
                                onclick="openGoogleMaps('machine-address-input')">Karte öffnen</button>
                        </div>
                        <div id="address-suggestions" class="suggestions-box" style="display:none;"></div>
                    </div>

                    <div class="form-group">
                        <label>Maschinenstandort (Karte öffnen)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="machine-location-input" placeholder="Straße, PLZ, Stadt, Land"
                                style="flex:1;"
                                oninput="debounceSearchAddress('machine-location-input', 'location-suggestions')">
                            <button type="button" class="btn-secondary"
                                onclick="openGoogleMaps('machine-location-input')">Karte öffnen</button>
                        </div>
                        <div id="location-suggestions" class="suggestions-box" style="display:none;"></div>
                    </div>

                    <div id="machine-map" style="display:none;"></div> <!-- Map hidden/removed -->
                    <!-- Hidden Lat/Lng fields kept for potential future use or address geocoding if needed -->
                    <input type="hidden" id="machine-lat">
                    <input type="hidden" id="machine-lng">
                    <input type="hidden" id="machine-full-address">

                    <input type="file" id="machine-image-upload" multiple class="hidden-file-input">
                    <input type="hidden" id="machine-image-url">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddMachineModal()">Abbrechen</button>
                    <button type="button" class="btn-primary" onclick="submitNewMachine()">Maschine anlegen</button>
                </div>
            </div>
        </div>

        <!-- Task Details/Edit Modal -->
        <div id="task-modal" class="modal-backdrop hidden">
            <div class="modal-content glass-card" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 id="task-modal-title">Aufgabe bearbeiten</h2>
                    <button class="close-modal-btn" onclick="closeTaskModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
                        <!-- Left Column: Details -->
                        <div class="task-modal-details">
                            <div class="form-group">
                                <label>Titel</label>
                                <input type="text" id="task-title" class="glass-input" placeholder="Titel der Aufgabe">
                            </div>
                            <div class="form-group">
                                <label>Beschreibung</label>
                                <textarea id="task-description" class="glass-input" rows="5"
                                    placeholder="Details zur Aufgabe..."></textarea>
                            </div>

                            <div class="subtasks-section" style="margin-top: 2rem;">
                                <h3 class="section-title">Unteraufgaben</h3>
                                <div id="subtask-list" class="subtask-list">
                                    <!-- Dynamically populated -->
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <input type="text" id="new-subtask-input" class="glass-input"
                                        placeholder="Neue Unteraufgabe hinzufügen..."
                                        onkeypress="if(event.key === 'Enter') addSubtask()">
                                    <button class="btn-secondary compact" onclick="addSubtask()">Hinzufügen</button>
                                </div>
                            </div>

                            <div class="comments-section" style="margin-top: 2rem;">
                                <h3 class="section-title">Kommentare</h3>
                                <div id="comment-list" class="comment-list">
                                    <!-- Dynamically populated -->
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <textarea id="new-comment-input" class="glass-input" rows="2"
                                        placeholder="Kommentar schreiben..."></textarea>
                                    <button class="btn-primary compact" onclick="addComment()">Senden</button>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Meta -->
                        <div class="task-modal-meta">
                            <div class="form-group">
                                <label>Status</label>
                                <select id="task-status" class="glass-input">
                                    <option value="open">Offen</option>
                                    <option value="in_progress">In Bearbeitung</option>
                                    <option value="completed">Erledigt</option>
                                    <option value="on_hold">Wartend</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Priorität</label>
                                <select id="task-priority" class="glass-input">
                                    <option value="low">Niedrig</option>
                                    <option value="medium">Mittel</option>
                                    <option value="high">Hoch</option>
                                    <option value="critical">Kritisch</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Projekt</label>
                                <select id="task-project" class="glass-input">
                                    <option value="">Kein Projekt</option>
                                    <!-- Dynamically populated -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Deadline</label>
                                <input type="date" id="task-deadline" class="glass-input">
                            </div>
                            <div class="form-group">
                                <label>Zuständig</label>
                                <div class="custom-filter-dropdown" id="task-user-select-trigger" style="width: 100%;">
                                    <span class="filter-label" id="task-assigned-users-label">Niemand zugewiesen</span>
                                    <svg class="filter-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                    <div class="custom-filter-menu" id="task-user-select-menu"
                                        style="width: 100%; max-height: 250px; overflow-y: auto;">
                                        <ul id="task-user-options">
                                            <!-- Dynamically populated with checkboxes -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeTaskModal()">Abbrechen</button>
                    <button class="btn-primary" onclick="saveTask()">Änderungen speichern</button>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const sidebarToggle = document.getElementById('sidebar-toggle');
                const sidebar = document.getElementById('sidebar');
                const mainWrapper = document.getElementById('main-wrapper');

                if (sidebarToggle && sidebar && mainWrapper) {
                    sidebarToggle.addEventListener('click', function () {
                        sidebar.classList.toggle('collapsed');
                        mainWrapper.classList.toggle('collapsed-sidebar');
                    });
                }
            });
        </script>

        <!-- Load scripts -->
        <script src="machines-grouped.js"></script>
        <script src="protocols.js"></script>
        <!-- Procurement Modal -->
        <div id="procurement-modal" class="modal-backdrop hidden">
            <div class="modal-content glass-card" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 id="procurement-modal-title">Neue Bestellung</h2>
                    <button class="close-modal-btn" onclick="closeProcurementModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="procurement-form" onsubmit="event.preventDefault(); saveProcurement();">
                        <input type="hidden" id="procurement-id">

                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label>Titel / Bezeichnung</label>
                                <input type="text" id="proc-title" class="glass-input" required
                                    placeholder="Was wird benötigt?">
                            </div>
                            <div class="form-group">
                                <label>Kategorie</label>
                                <div class="custom-filter-dropdown" id="proc-category-dropdown" style="width: 100%;">
                                    <span class="filter-label" id="proc-category-label">🔧 Maschinenersatzteil</span>
                                    <input type="hidden" id="proc-category" value="machine_part">
                                    <svg class="filter-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                    <div class="custom-filter-menu">
                                        <ul class="dropdown-options" onclick="selectProcurementCategory(event)">
                                            <li data-value="machine_part">🔧 Maschinenersatzteil</li>
                                            <li data-value="workshop_supplies">Werkstattbedarf</li>
                                            <li data-value="tools">🔨 Werkzeug</li>
                                            <li data-value="office_supplies">✏️ Bürobedarf</li>
                                            <li data-value="other">📦 Sonstiges</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Artikelbeschreibung</label>
                            <textarea id="proc-description" class="glass-input" rows="3"
                                placeholder="Detaillierte Beschreibung, Maße, Typ..."></textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label>Menge</label>
                                <input type="number" id="proc-quantity" class="glass-input" value="1" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Priorität</label>
                                <div class="custom-filter-dropdown" id="proc-priority-dropdown" style="width: 100%;">
                                    <span class="filter-label" id="proc-priority-label">Normal</span>
                                    <input type="hidden" id="proc-priority" value="normal">
                                    <svg class="filter-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                    <div class="custom-filter-menu">
                                        <ul class="dropdown-options" onclick="selectProcurementPriority(event)">
                                            <li data-value="low">Niedrig</li>
                                            <li data-value="normal">Normal</li>
                                            <li data-value="high">Hoch</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Lieferdatum (Opt.)</label>
                                <input type="date" id="proc-delivery-date" class="glass-input">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Link zum Produkt (Optional)</label>
                            <input type="url" id="proc-link" class="glass-input" placeholder="https://...">
                        </div>

                        <div class="form-group">
                            <label>Standort / Projekt (Optional)</label>
                            <input type="text" id="proc-location" class="glass-input"
                                placeholder="Für welche Maschine oder Projekt?">
                        </div>

                        <div class="form-group">
                            <label>Bemerkungen</label>
                            <textarea id="proc-remarks" class="glass-input" rows="2"></textarea>
                        </div>

                        <!-- Hidden fields for logic -->
                        <input type="hidden" id="proc-status" value="new">

                    </form>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeProcurementModal()">Abbrechen</button>
                    <button type="button" class="btn-primary" onclick="saveProcurement()">Bestellung speichern</button>
                </div>
            </div>
        </div>

        <script src="tasks.js"></script>
        <script src="procurements.js"></script>
    </div><!-- End app-layout -->
</body>

</html>
</body>

</html>